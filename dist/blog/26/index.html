<!DOCTYPE html>
<html data-html-server-rendered="true" lang="ja" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22ja%22%7D%7D">
  <head>
    <title>エンタープライズなAWSサーバーレスアプリケーションを構成管理する時の方法と考え方 | Serverless Operations</title><meta name="gridsome:hash" content="899a7dadc9c3ff481284dbd8cf731b9f93beffd5"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.14"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="og:locale" property="og:locale" content="ja_JP"><meta data-vue-tag="ssr" data-key="og:site_name" property="og:site_name" content="Serverless Operations"><meta data-vue-tag="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" name="twitter:image" content="https://serverless.co.jp/ogp.png"><meta data-vue-tag="ssr" data-key="og:type" property="og:type" content="article"><meta data-vue-tag="ssr" data-key="og:url" property="og:url" content="https://serverless.co.jp/blog/26/"><meta data-vue-tag="ssr" data-key="og:image" property="og:image" content="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/05/https___qiita-image-store.s3.ap-northeast-1.amazonaws.com_0_65478_8c340426-2aa6-94e1-469d-1684569d9809.png"><meta data-vue-tag="ssr" data-key="og:title" property="og:title" content="エンタープライズなAWSサーバーレスアプリケーションを構成管理する時の方法と考え方 | Serverless Operations"><meta data-vue-tag="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" name="twitter:image" content="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/05/https___qiita-image-store.s3.ap-northeast-1.amazonaws.com_0_65478_8c340426-2aa6-94e1-469d-1684569d9809.png"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css"><link data-vue-tag="ssr" data-key="canonical" rel="canonical" href="https://serverless.co.jp/blog/26/"><link rel="preload" href="/assets/css/0.styles.adfe40b8.css" as="style"><link rel="preload" href="/assets/js/app.f355efd1.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--word-press-blog-vue.fdf3ed1a.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules--gridsome--app--pages--404-vue.84e8aa18.js"><link rel="prefetch" href="/assets/js/page--src--pages--about-vue.094252a3.js"><link rel="prefetch" href="/assets/js/page--src--pages--blog-archives-vue.771d12fd.js"><link rel="prefetch" href="/assets/js/page--src--pages--contact-vue.c49312ad.js"><link rel="prefetch" href="/assets/js/page--src--pages--download-vue.e2fb64ed.js"><link rel="prefetch" href="/assets/js/page--src--pages--event-archives-vue.dc6c64cc.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.8d1729b1.js"><link rel="prefetch" href="/assets/js/page--src--pages--news-archives-vue.2871bf8d.js"><link rel="prefetch" href="/assets/js/page--src--pages--our-products-vue.d569f152.js"><link rel="prefetch" href="/assets/js/page--src--pages--privacy-policy-vue.9015b9cf.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--aws-serverless-vue.548b9c96.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--aws-serverless-vue~page--src--pages--services--iot-serverless-vue.bada637e.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--index-vue.605da173.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--iot-serverless-vue.1324af58.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--serverless-consulting-vue.bf933f33.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--serverless-development-vue.d8c60529.js"><link rel="prefetch" href="/assets/js/page--src--pages--test-form-vue.37425afa.js"><link rel="prefetch" href="/assets/js/page--src--pages--works-archives-vue.b641ea0a.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-category-vue.7424850d.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-post-tag-vue.a058c92f.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-post-vue.8fb7ceee.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-works-vue.dc66c364.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--contact-vue~page--src--pages--download-vue.7a23cb3f.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--our-products-vue.8e9052c2.js"><link rel="prefetch" href="/assets/js/vendors~page--src--templates--word-press-blog-vue.16b09ab1.js"><link rel="stylesheet" href="/assets/css/0.styles.adfe40b8.css"><script data-vue-tag="ssr">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-MLP4448');</script><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div id="app" data-server-rendered="true" class="v-application v-application--is-ltr theme--dark" data-v-7de3dd27><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MLP4448" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="v-application--wrap"><header class="header-nav" data-v-5f4f5539><div class="header-nav__logo-block" data-v-5f4f5539><a href="/" class="header-nav__logo-link active" data-v-5f4f5539><img src="/assets/img/header-logo.a93f880b.svg" alt="Severless Operations ロゴ" class="header-nav__logo" data-v-5f4f5539></a></div><nav data-v-5f4f5539><ul data-v-5f4f5539><li data-v-5f4f5539><a href="/about" data-v-5f4f5539>私たちについて</a></li><li data-v-5f4f5539><a href="/services" data-v-5f4f5539>サービス</a></li><li data-v-5f4f5539><a href="/works-archives" data-v-5f4f5539>実績紹介</a></li><li data-v-5f4f5539><a href="/blog-archives" data-v-5f4f5539>ブログ</a></li><li data-v-5f4f5539><a href="/news-archives" data-v-5f4f5539>お知らせ</a></li><li data-v-5f4f5539><a href="/download" data-v-5f4f5539>会社資料ダウンロード</a></li><li data-v-5f4f5539><a href="/contact" data-v-5f4f5539>お問い合わせ</a></li></ul></nav><div id="app" class="header-nav__toggler-block d-block d-md-none" data-v-5f4f5539><button id="btn" type="button" class="header-nav__toggler-button btn" data-v-5f4f5539><div tabindex="-1" class="btn__content" data-v-5f4f5539><span class="header-nav__toggler-top" data-v-5f4f5539></span><span class="header-nav__toggler-middle" data-v-5f4f5539></span><span class="header-nav__toggler-bottom" data-v-5f4f5539></span></div></button></div><!----></header><main class="v-content"><div class="v-content" data-v-7de3dd27><div class="v-content__wrap" data-v-7de3dd27><div class="container" data-v-7de3dd27><p class="category-title" data-v-7de3dd27>
          Blog
        </p></div><header class="post-header" data-v-7de3dd27><div class="container" data-v-7de3dd27><div class="row justify-center" data-v-7de3dd27><div class="col-md-10 col-11" data-v-7de3dd27><h1 class="post-title" data-v-7de3dd27>エンタープライズなAWSサーバーレスアプリケーションを構成管理する時の方法と考え方</h1><div class="post-tag-container" data-v-7de3dd27><time datetime="2020.05.11" class="post-date" data-v-7de3dd27> 
                  2020.05.11
                  
                </time><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>AWS</span></div><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>Serverless</span></div></div></div></div></div></header><article class="post-container" data-v-7de3dd27><div class="container" data-v-7de3dd27><div class="row justify-center" data-v-7de3dd27><div class="post-article-container col-md-10 col-11" data-v-7de3dd27><div class="post-article" data-v-7de3dd27>
<h2 class="wp-block-heading">概要</h2>



<p>AWSでサーバーレスアーキテクチャでアプリケーションを構築する際、多くの場合はたくさんのLambdaやフルマネージドサービスで構成されることになります。その際にどういったディレクトリ構成でどのようにソースコードを構成してCI/CDを回していけばよいかをこの記事では書いています。</p>



<p>結論としては、<a href="https://github.com/serverless-operations/serverless-enterprise-application-boilerplate-for-python" rel="noreferrer noopener" target="_blank">Serverless Enterprise Application Boilerplate For Python</a>に実際のソースコードとしてまとめていますので、より詳細はこちらを確認してもらえればと思います。</p>



<h2 class="wp-block-heading">使用しているサービスとツール</h2>



<p>本記事ではCI環境としてCircleCIを使っています。GitHub ActionsやCodeBuildでも同じようなことが可能なはずなので、これらは好みで選べば良いでしょう。</p>



<p>また、デプロイツールとしてServerless Frameworkを使っています。SAMでもCDKでも大体同じことは可能なので、どれを選ぶかは好みを最優先して良いでしょう。</p>



<p>以降、これらのデプロイツールを使うと最終的にはCloudFormationに展開されるので、CloudFormationの前提で記述します。</p>



<h2 class="wp-block-heading">アプリケーション内部でサービスを分割しよう</h2>



<p>冒頭でも述べたとおり、エンタープライズなアプリケーションになるとたくさんのAWSサービスを構成管理する必要があります。それをひとつのファイルで管理するのは流石に無理があるため、細かくサービスの単位に分割して構成管理をするようにします。分割した単位でCloudFormationの1スタックがデプロイされるイメージです。</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2F8c340426-2aa6-94e1-469d-1684569d9809.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7c108f849d6de6847591547768086518" target="_blank" rel="noreferrer noopener"><img decoding="async" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2F8c340426-2aa6-94e1-469d-1684569d9809.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7c108f849d6de6847591547768086518" alt="Untitled (2).png"/></a></figure></div>



<p>まずポイントとしてはステートを持つサービスと持たないサービスを明確に分離します。DynamoDBやS3のようなデータを永続化させるサービスとLambdaのようにデータを永続化しないサービスは当然デプロイのサイクルも頻度も違います。それらが違うものは明確に分離させたほうがいいでしょう。</p>



<p>そしてアプリケーションの入り口となるAPI達は1つのスタックにしてしまいます。残りのバックエンドで処理をしてくれるものは処理として完結できる意味のある単位で分けるのが良いでしょう。そしてそれぞれのバックエンドサービス間で値のやり取りが発生するケースも多いと思うので、どのようにそれらのサービス間でデータを受け渡しするのかも考えておきましょう。</p>



<p>具体的に考えられるデータの受け渡し方法は以下のとおりです。</p>



<ul><li>EventBridgeやSQSにデータをPublishして引き継ぐ</li><li>DBに値を入れておいて、別のサービスからデータをポーリングして受け取る</li><li>API Gatewayでhttpエンドポイントを用意してそこにデータを渡す</li><li>S3を使用してのファイル連携</li></ul>



<h2 class="wp-block-heading">ディレクトリ構成</h2>



<p><a href="https://github.com/serverless-operations/serverless-enterprise-application-boilerplate-for-python" rel="noreferrer noopener" target="_blank">Serverless Enterprise Application Boilerplate For Python</a>を見てもらえるとわかるかと思いますが、以下のようなルールでディレクトリ構成を決めます</p>



<figure class="wp-block-table"><table><thead><tr><th>ディレクトリ</th><th>用途</th></tr></thead><tbody><tr><td>layer</td><td>Lambda Layerとしてデプロイする外部のライブラリや共通処理として定義したコードを参照先としてlayerとなるCloudFormationを定義します。</td></tr><tr><td>resources</td><td>DynamoDBやS3、SSMなどデータを保持するサービスのCloudFormationを定義します。</td></tr><tr><td>lib</td><td>共通処理として定義したコードを定義します。これらはLambda Layerとしてデプロイします。</td></tr><tr><td>services</td><td>1つ前のセクションで分割した各サービスを格納します。1サービス1CloudFormationスタックの単位で定義していきます。</td></tr><tr><td>tests</td><td>テストコードを格納します。ユニットテストとインテグレーションテストが主に入ります。</td></tr></tbody></table></figure>



<h2 class="wp-block-heading">サービス間での値の参照</h2>



<p>細かくサービスやリソースの単位でCloudformationを分割するので、当然ながらDBのTable名やArnの値は複数のサービスから参照させる必要があります。</p>



<p>その場合はCloudFormationの<a href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html" rel="noreferrer noopener" target="_blank">クロススタック出力</a>やServerless Frameworkであれば、<a href="https://www.serverless.com/framework/docs/providers/aws/guide/variables#reference-cloudformation-outputs" rel="noreferrer noopener" target="_blank">Reference CloudFormation Outputs</a>の機能を使うことでスタック間で値を参照できます。</p>



<p>なので、外部のスタックから参照させたい値はCloudFormationのOutPutsに出力して参照できるようにしておきましょう。</p>



<p>CloudFormationの<a rel="noreferrer noopener" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-importvalue.html" target="_blank">ImportValue</a>の機能を使えば以下の様に書くことで値が参照できます。 </p>



<pre class="wp-block-code language-yaml"><code>Fn::ImportValue: &lt;Export名></code></pre>



<p>また、Serverless Frameworkの機能を使うと以下のように記述できます </p>



<pre class="wp-block-code language-ssh"><code>${cf.&lt;リージョン名>:&lt;CloudFormationスタック名>.&lt;output名>}

tableArn: ${cf.ap-northeast-1:dev-stack.tableArn}</code></pre>



<h2 class="wp-block-heading">テストの方針</h2>



<p>サーバーレスアプリケーションを作る上での多くのケースではユニットテストとインテグレーションテストの2パターンを行います。</p>



<p>ユニットテストは通常のアプリケーションで実行するユニットテストです。インテグレーションテストは実際にAWS環境にデプロイしてその実行結果をテストします。</p>



<p>インテグレーションテストを必ず行うことがサーバーレスアプリケーションでは特徴的かもしれません。どうしても分散型のアプリケーションではユニットテストだけではテストをやりきることが難しいです。実際にユニットテストが通ってもIAMの設定が足りずに動かないかもしれません。そういったクラウド独自の仕組みも含めて処理が完了することを確認するためにインテグレーションテストを行います。</p>



<p>基本的には正常系を1パターン以上インテグレーションテストを記述します。そして内部的なバリデーション等のロジックをユニットテストでカバーするのが良いでしょう。</p>



<p>例えばAPIのインテグレーションテストのCIの設定例を見てみましょう。「Deploy API for integration test」のフェーズでAWS環境に必要なリソースをデプロイします。その後「Run API integration test」で実際にAWS上で期待通りの動作をするかのテストを行います。 </p>



<pre class="wp-block-code language-yaml"><code>  api_test:
    executor:
      name: default
    steps:
      - attach_workspace:
          at: ~/workspace
      - run: *install_sls
      - run:
          name: Deploy API for integration test
          command: |
            . venv/bin/activate
            yarn deploy:db
            yarn deploy:layer
            yarn deploy:api
          environment:
            STAGE: 1
      - run:
          name: Run API integration test
          command: |
            . venv/bin/activate
            yarn test:api
          environment:
            STAGE: 1</code></pre>



<h2 class="wp-block-heading">AWSアカウントの分け方</h2>



<p>サーバーレスアプリケーションでなくてもこれは同様かと思いますが、本番とそれ以外の環境でアカウントを分離します。</p>



<p>本番でないアカウントの方では各開発者ごとの環境とステージングの環境が存在します。Serverless FrameworkであればStageの機能を使ってこれらの環境を切り分けるのが良いでしょう。そして、本番とそれ以外のデプロイ先の切り替えはCircleCIのContextの機能を使います。</p>



<p>この機能を使えば条件に応じて適用する環境変数のセットを切り替えることが出来るので、それを利用してアカウントの切り替えを行います。</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Ff528a480-dc5a-a1e3-2571-74328bb52cfb.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4725b3b70c77c0d68c0d45598f027cfc" target="_blank" rel="noreferrer noopener"><img decoding="async" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Ff528a480-dc5a-a1e3-2571-74328bb52cfb.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4725b3b70c77c0d68c0d45598f027cfc" alt="accounts.png"/></a></figure></div>



<h2 class="wp-block-heading">CI/CDパイプライン</h2>



<p>ステージング及び本番についてはCI環境から自動デプロイを行います。以下のような条件で自動デプロイを設定します。</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Fcadda769-352c-d271-86fb-085aa0aec837.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d82d7ac8ea9e8f306e1040b50c9d73c1" target="_blank" rel="noreferrer noopener"><img decoding="async" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Fcadda769-352c-d271-86fb-085aa0aec837.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d82d7ac8ea9e8f306e1040b50c9d73c1" alt="Untitled (1).png"/></a></figure></div>



<p>以下は具体的にmasterブランチにマージされた際のCircleCIのワークフローになります。<br><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Fd3e01c16-81ca-4789-b42f-0cc736c7f6e3.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=fedb744ae5c8d54a4e1f5e9cde3a21a7" target="_blank" rel="noreferrer noopener"></a></p>



<figure class="wp-block-image"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Fd3e01c16-81ca-4789-b42f-0cc736c7f6e3.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=fedb744ae5c8d54a4e1f5e9cde3a21a7" target="_blank" rel="noreferrer noopener"><img decoding="async" src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Fd3e01c16-81ca-4789-b42f-0cc736c7f6e3.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=fedb744ae5c8d54a4e1f5e9cde3a21a7" alt="スクリーンショット 2020-05-11 8.54.15.png"/></a></figure>



<p>以下のような順でワークフローを定義しています。<br>1. 環境のセットアップ<br>2. Lintによる構文チェック<br>3. ユニットテスト<br>4. インテグレーションテスト<br>5. ステージングへのデプロイ</p>



<h2 class="wp-block-heading">まとめ</h2>



<p>以上でディレクトリ構成からテストやデプロイまでの方針の考え方を述べてきました。<br>このようにすることで複数のスタックから構成される大規模なサーバーレスアプリケーションでもスッキリと構成管理を行って運用することが出来ます。<br>是非皆さんもこれを参考にサーバーレスアーキテクチャの導入にチャレンジしてもらえるとうれしいです。</p>
</div><section class="l-share-button" data-v-629ec8b5 data-v-7de3dd27><aside class="p-share-button" data-v-629ec8b5><div class="p-share-button__header" data-v-629ec8b5>SHARE</div><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fserverless.co.jp%2Fblog%2F26%2F" target="_blank" title="Facebookでシェア" class="p-share-button__link--facebook " data-v-629ec8b5><i class="mdi mdi-facebook" data-v-629ec8b5></i></a><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fserverless.co.jp%2Fblog%2F26%2F&amp;text=%E3%82%A8%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%97%E3%83%A9%E3%82%A4%E3%82%BA%E3%81%AAAWS%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%83%AC%E3%82%B9%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E6%A7%8B%E6%88%90%E7%AE%A1%E7%90%86%E3%81%99%E3%82%8B%E6%99%82%E3%81%AE%E6%96%B9%E6%B3%95%E3%81%A8%E8%80%83%E3%81%88%E6%96%B9" target="_blank" title="Twitterでシェア" class="p-share-button__link--twitter" data-v-629ec8b5><i class="mdi mdi-twitter" data-v-629ec8b5></i></a></aside></section><div class="post-author-container" data-v-7de3dd27><h5 class="post-author-title" data-v-7de3dd27>Written by</h5><div class="post-author-text" data-v-7de3dd27><p data-v-7de3dd27><span class="role" data-v-7de3dd27>
                      CEO
                    </span><span class="name-jp" data-v-7de3dd27>
                      堀家 隆宏
                    </span><span class="name-en" data-v-7de3dd27>
                      Takahiro Horike
                    </span></p><p class="author-desc" data-v-7de3dd27>
                    Co-founder and CEO of Serverless Operations, Inc
                  </p><ul class="author-sns" data-v-7de3dd27><li data-v-7de3dd27><a href="https://github.com/horike37" target="_blank" class="github" data-v-7de3dd27><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" data-v-7de3dd27></i></a></li><li data-v-7de3dd27><a href="https://www.facebook.com/horike.takahiro" target="_blank" class="facebook" data-v-7de3dd27><i aria-hidden="true" class="v-icon notranslate mdi mdi-facebook theme--light" data-v-7de3dd27></i></a></li><li data-v-7de3dd27><a href="https://twitter.com/horike37" target="_blank" class="twitter" data-v-7de3dd27><i aria-hidden="true" class="v-icon notranslate mdi mdi-twitter theme--light" data-v-7de3dd27></i></a></li></ul></div></div></div></div></div><div class="p-news-bg" data-v-7de3dd27></div></article><div class="container" data-v-7de3dd27><div class="row justify-center" data-v-7de3dd27><a href="/blog-archives" class="post-archives-link" data-v-7de3dd27><span class="post-archives-link-text" data-v-7de3dd27>BACK TO LIST</span><span data-v-7de3dd27><img src="/assets/img/icon-back-to-list.3add3700.svg" alt="BACK TO LIST アイコン" data-v-7de3dd27></span></a></div></div></div></div></main><footer class="v-footer footer v-sheet v-sheet--tile theme--dark" data-v-a49f4c2c><div class="container" data-v-a49f4c2c data-v-a49f4c2c><div class="row" data-v-a49f4c2c data-v-a49f4c2c><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><a href="/works-archives" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>Works</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>実績紹介</div></a><ul class="c-footer-list" data-v-a49f4c2c><div data-v-b68eaa08 data-v-a49f4c2c><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/666/" class="c-footer-list__link" data-v-b68eaa08>
      A社（企業名非公開）
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/501/" class="c-footer-list__link" data-v-b68eaa08>
      戸田建設株式会社
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/396/" class="c-footer-list__link" data-v-b68eaa08>
      北海道テレビ放送株式会社
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/358/" class="c-footer-list__link" data-v-b68eaa08>
      株式会社Geolonia
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/24/" class="c-footer-list__link" data-v-b68eaa08>
      株式会社LIXIL
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/185/" class="c-footer-list__link" data-v-b68eaa08>
      株式会社TOKION
    </a></li></div></ul></div><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><div data-v-a49f4c2c><a href="/services" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>Services</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>サービス紹介</div></a></div><ul class="c-footer-list" data-v-a49f4c2c><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services" class="c-footer-list__link" data-v-a49f4c2c>サーバーレスオペレーションズの<br data-v-a49f4c2c>サービスと強み</a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/iot-serverless" class="c-footer-list__link" data-v-a49f4c2c>
              IoT × サーバーレス / コンテナ開発<br data-v-a49f4c2c>導⼊サポート
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/aws-serverless" class="c-footer-list__link" data-v-a49f4c2c>
              AWSコアサーバーレスサービスの開発導⼊サポート
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/serverless-consulting" class="c-footer-list__link" data-v-a49f4c2c>サーバーレスコンサルティング</a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/serverless-development" class="c-footer-list__link" data-v-a49f4c2c>サーバーレスディべロプメント</a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/our-products" class="c-footer-list__link" data-v-a49f4c2c>
              自社開発プロダクト
            </a></li></ul></div><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><a href="/blog-archives" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>Blog</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>開発ブログ</div></a><ul class="c-footer-list" data-v-a49f4c2c><div data-v-39434060 data-v-a49f4c2c><li class="c-footer-list__item" data-v-39434060><a href="/blog/640/" class="c-footer-list__link" data-v-39434060>
      AWS 開発基盤として、セキュリティを考慮したマルチアカウント構成のススメ
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/532/" class="c-footer-list__link" data-v-39434060>
      AWS Amplify GraphQL Transformer v2 のデータモデリングとリレーションの仕組みを解説する
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/512/" class="c-footer-list__link" data-v-39434060>
      AWS Lambda + Nuxt3で実現する「サーバーレスなSSR」とその構成
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/25/" class="c-footer-list__link" data-v-39434060>
      Serverless Frameworkの使い方まとめ
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/450/" class="c-footer-list__link" data-v-39434060>
      軽量で簡単に使えるキャッシュSaaS、MomentoをAWS Lambdaから使ってみる
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/429/" class="c-footer-list__link" data-v-39434060>
      Next.js アプリケーションを AWS Amplify でホスティングする上でのTIPS
    </a></li></div></ul></div><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><a href="/about" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>About</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>会社案内</div></a><ul class="c-footer-list" data-v-a49f4c2c><li class="c-footer-list__item" data-v-a49f4c2c><a href="/about" class="c-footer-list__link" data-v-a49f4c2c>
              会社案内
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/news-archives/" class="c-footer-list__link" data-v-a49f4c2c>
              おしらせ
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/privacy-policy/" class="c-footer-list__link" data-v-a49f4c2c>
              プライバシーポリシー
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/download" class="c-footer-list__link" data-v-a49f4c2c>
              会社資料ダウンロード
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/contact" class="c-footer-list__link" data-v-a49f4c2c>
              お問い合わせ
            </a></li></ul></div></div><div class="row mt-8 mt-md-12" data-v-a49f4c2c data-v-a49f4c2c><div class="col-md-2 col-12" data-v-a49f4c2c data-v-a49f4c2c><div data-v-a49f4c2c><a href="/" class="active" data-v-a49f4c2c><img src="/assets/img/footer-severless-operations-logo.e1e6687a.svg" alt="Severless Operations ロゴ" data-v-a49f4c2c></a></div></div><div class="col-md-10 col-12" data-v-a49f4c2c data-v-a49f4c2c><div class="sns-link text-md-right" data-v-a49f4c2c><a href="https://github.com/serverless-operations" target="_blank" class="sns-link__github" data-v-a49f4c2c><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" data-v-a49f4c2c></i></a><a href="https://twitter.com/slsopsinc" target="_blank" class="sns-link__twitter" data-v-a49f4c2c><i aria-hidden="true" class="v-icon notranslate mdi mdi-twitter theme--light" data-v-a49f4c2c></i></a></div></div><div class="footer-copyright" data-v-a49f4c2c>
        © Serverless Operations, inc
      </div></div></div></footer></div></div>
    <script>window.__INITIAL_STATE__={"data":{"wordPressBlog":{"title":"エンタープライズなAWSサーバーレスアプリケーションを構成管理する時の方法と考え方","content":"\n\u003Ch2 class=\"wp-block-heading\"\u003E概要\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003EAWSでサーバーレスアーキテクチャでアプリケーションを構築する際、多くの場合はたくさんのLambdaやフルマネージドサービスで構成されることになります。その際にどういったディレクトリ構成でどのようにソースコードを構成してCI\u002FCDを回していけばよいかをこの記事では書いています。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E結論としては、\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fserverless-operations\u002Fserverless-enterprise-application-boilerplate-for-python\" rel=\"noreferrer noopener\" target=\"_blank\"\u003EServerless Enterprise Application Boilerplate For Python\u003C\u002Fa\u003Eに実際のソースコードとしてまとめていますので、より詳細はこちらを確認してもらえればと思います。\u003C\u002Fp\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003E使用しているサービスとツール\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003E本記事ではCI環境としてCircleCIを使っています。GitHub ActionsやCodeBuildでも同じようなことが可能なはずなので、これらは好みで選べば良いでしょう。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Eまた、デプロイツールとしてServerless Frameworkを使っています。SAMでもCDKでも大体同じことは可能なので、どれを選ぶかは好みを最優先して良いでしょう。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E以降、これらのデプロイツールを使うと最終的にはCloudFormationに展開されるので、CloudFormationの前提で記述します。\u003C\u002Fp\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eアプリケーション内部でサービスを分割しよう\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003E冒頭でも述べたとおり、エンタープライズなアプリケーションになるとたくさんのAWSサービスを構成管理する必要があります。それをひとつのファイルで管理するのは流石に無理があるため、細かくサービスの単位に分割して構成管理をするようにします。分割した単位でCloudFormationの1スタックがデプロイされるイメージです。\u003C\u002Fp\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"aligncenter\"\u003E\u003Ca href=\"https:\u002F\u002Fqiita-user-contents.imgix.net\u002Fhttps%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2F8c340426-2aa6-94e1-469d-1684569d9809.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7c108f849d6de6847591547768086518\" target=\"_blank\" rel=\"noreferrer noopener\"\u003E\u003Cimg decoding=\"async\" src=\"https:\u002F\u002Fqiita-user-contents.imgix.net\u002Fhttps%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2F8c340426-2aa6-94e1-469d-1684569d9809.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7c108f849d6de6847591547768086518\" alt=\"Untitled (2).png\"\u002F\u003E\u003C\u002Fa\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003Eまずポイントとしてはステートを持つサービスと持たないサービスを明確に分離します。DynamoDBやS3のようなデータを永続化させるサービスとLambdaのようにデータを永続化しないサービスは当然デプロイのサイクルも頻度も違います。それらが違うものは明確に分離させたほうがいいでしょう。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Eそしてアプリケーションの入り口となるAPI達は1つのスタックにしてしまいます。残りのバックエンドで処理をしてくれるものは処理として完結できる意味のある単位で分けるのが良いでしょう。そしてそれぞれのバックエンドサービス間で値のやり取りが発生するケースも多いと思うので、どのようにそれらのサービス間でデータを受け渡しするのかも考えておきましょう。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E具体的に考えられるデータの受け渡し方法は以下のとおりです。\u003C\u002Fp\u003E\n\n\n\n\u003Cul\u003E\u003Cli\u003EEventBridgeやSQSにデータをPublishして引き継ぐ\u003C\u002Fli\u003E\u003Cli\u003EDBに値を入れておいて、別のサービスからデータをポーリングして受け取る\u003C\u002Fli\u003E\u003Cli\u003EAPI Gatewayでhttpエンドポイントを用意してそこにデータを渡す\u003C\u002Fli\u003E\u003Cli\u003ES3を使用してのファイル連携\u003C\u002Fli\u003E\u003C\u002Ful\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eディレクトリ構成\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fserverless-operations\u002Fserverless-enterprise-application-boilerplate-for-python\" rel=\"noreferrer noopener\" target=\"_blank\"\u003EServerless Enterprise Application Boilerplate For Python\u003C\u002Fa\u003Eを見てもらえるとわかるかと思いますが、以下のようなルールでディレクトリ構成を決めます\u003C\u002Fp\u003E\n\n\n\n\u003Cfigure class=\"wp-block-table\"\u003E\u003Ctable\u003E\u003Cthead\u003E\u003Ctr\u003E\u003Cth\u003Eディレクトリ\u003C\u002Fth\u003E\u003Cth\u003E用途\u003C\u002Fth\u003E\u003C\u002Ftr\u003E\u003C\u002Fthead\u003E\u003Ctbody\u003E\u003Ctr\u003E\u003Ctd\u003Elayer\u003C\u002Ftd\u003E\u003Ctd\u003ELambda Layerとしてデプロイする外部のライブラリや共通処理として定義したコードを参照先としてlayerとなるCloudFormationを定義します。\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Eresources\u003C\u002Ftd\u003E\u003Ctd\u003EDynamoDBやS3、SSMなどデータを保持するサービスのCloudFormationを定義します。\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Elib\u003C\u002Ftd\u003E\u003Ctd\u003E共通処理として定義したコードを定義します。これらはLambda Layerとしてデプロイします。\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Eservices\u003C\u002Ftd\u003E\u003Ctd\u003E1つ前のセクションで分割した各サービスを格納します。1サービス1CloudFormationスタックの単位で定義していきます。\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Etests\u003C\u002Ftd\u003E\u003Ctd\u003Eテストコードを格納します。ユニットテストとインテグレーションテストが主に入ります。\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003C\u002Ftbody\u003E\u003C\u002Ftable\u003E\u003C\u002Ffigure\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eサービス間での値の参照\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003E細かくサービスやリソースの単位でCloudformationを分割するので、当然ながらDBのTable名やArnの値は複数のサービスから参照させる必要があります。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Eその場合はCloudFormationの\u003Ca href=\"https:\u002F\u002Fdocs.aws.amazon.com\u002Fja_jp\u002FAWSCloudFormation\u002Flatest\u002FUserGuide\u002Foutputs-section-structure.html\" rel=\"noreferrer noopener\" target=\"_blank\"\u003Eクロススタック出力\u003C\u002Fa\u003EやServerless Frameworkであれば、\u003Ca href=\"https:\u002F\u002Fwww.serverless.com\u002Fframework\u002Fdocs\u002Fproviders\u002Faws\u002Fguide\u002Fvariables#reference-cloudformation-outputs\" rel=\"noreferrer noopener\" target=\"_blank\"\u003EReference CloudFormation Outputs\u003C\u002Fa\u003Eの機能を使うことでスタック間で値を参照できます。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Eなので、外部のスタックから参照させたい値はCloudFormationのOutPutsに出力して参照できるようにしておきましょう。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003ECloudFormationの\u003Ca rel=\"noreferrer noopener\" href=\"https:\u002F\u002Fdocs.aws.amazon.com\u002Fja_jp\u002FAWSCloudFormation\u002Flatest\u002FUserGuide\u002Fintrinsic-function-reference-importvalue.html\" target=\"_blank\"\u003EImportValue\u003C\u002Fa\u003Eの機能を使えば以下の様に書くことで値が参照できます。 \u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-yaml\"\u003E\u003Ccode\u003EFn::ImportValue: &lt;Export名\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003Eまた、Serverless Frameworkの機能を使うと以下のように記述できます \u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-ssh\"\u003E\u003Ccode\u003E${cf.&lt;リージョン名\u003E:&lt;CloudFormationスタック名\u003E.&lt;output名\u003E}\n\ntableArn: ${cf.ap-northeast-1:dev-stack.tableArn}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eテストの方針\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003Eサーバーレスアプリケーションを作る上での多くのケースではユニットテストとインテグレーションテストの2パターンを行います。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Eユニットテストは通常のアプリケーションで実行するユニットテストです。インテグレーションテストは実際にAWS環境にデプロイしてその実行結果をテストします。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Eインテグレーションテストを必ず行うことがサーバーレスアプリケーションでは特徴的かもしれません。どうしても分散型のアプリケーションではユニットテストだけではテストをやりきることが難しいです。実際にユニットテストが通ってもIAMの設定が足りずに動かないかもしれません。そういったクラウド独自の仕組みも含めて処理が完了することを確認するためにインテグレーションテストを行います。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E基本的には正常系を1パターン以上インテグレーションテストを記述します。そして内部的なバリデーション等のロジックをユニットテストでカバーするのが良いでしょう。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E例えばAPIのインテグレーションテストのCIの設定例を見てみましょう。「Deploy API for integration test」のフェーズでAWS環境に必要なリソースをデプロイします。その後「Run API integration test」で実際にAWS上で期待通りの動作をするかのテストを行います。 \u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-yaml\"\u003E\u003Ccode\u003E  api_test:\n    executor:\n      name: default\n    steps:\n      - attach_workspace:\n          at: ~\u002Fworkspace\n      - run: *install_sls\n      - run:\n          name: Deploy API for integration test\n          command: |\n            . venv\u002Fbin\u002Factivate\n            yarn deploy:db\n            yarn deploy:layer\n            yarn deploy:api\n          environment:\n            STAGE: 1\n      - run:\n          name: Run API integration test\n          command: |\n            . venv\u002Fbin\u002Factivate\n            yarn test:api\n          environment:\n            STAGE: 1\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003EAWSアカウントの分け方\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003Eサーバーレスアプリケーションでなくてもこれは同様かと思いますが、本番とそれ以外の環境でアカウントを分離します。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E本番でないアカウントの方では各開発者ごとの環境とステージングの環境が存在します。Serverless FrameworkであればStageの機能を使ってこれらの環境を切り分けるのが良いでしょう。そして、本番とそれ以外のデプロイ先の切り替えはCircleCIのContextの機能を使います。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Eこの機能を使えば条件に応じて適用する環境変数のセットを切り替えることが出来るので、それを利用してアカウントの切り替えを行います。\u003C\u002Fp\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"aligncenter\"\u003E\u003Ca href=\"https:\u002F\u002Fqiita-user-contents.imgix.net\u002Fhttps%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Ff528a480-dc5a-a1e3-2571-74328bb52cfb.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4725b3b70c77c0d68c0d45598f027cfc\" target=\"_blank\" rel=\"noreferrer noopener\"\u003E\u003Cimg decoding=\"async\" src=\"https:\u002F\u002Fqiita-user-contents.imgix.net\u002Fhttps%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Ff528a480-dc5a-a1e3-2571-74328bb52cfb.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4725b3b70c77c0d68c0d45598f027cfc\" alt=\"accounts.png\"\u002F\u003E\u003C\u002Fa\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003ECI\u002FCDパイプライン\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003Eステージング及び本番についてはCI環境から自動デプロイを行います。以下のような条件で自動デプロイを設定します。\u003C\u002Fp\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"aligncenter\"\u003E\u003Ca href=\"https:\u002F\u002Fqiita-user-contents.imgix.net\u002Fhttps%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Fcadda769-352c-d271-86fb-085aa0aec837.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d82d7ac8ea9e8f306e1040b50c9d73c1\" target=\"_blank\" rel=\"noreferrer noopener\"\u003E\u003Cimg decoding=\"async\" src=\"https:\u002F\u002Fqiita-user-contents.imgix.net\u002Fhttps%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Fcadda769-352c-d271-86fb-085aa0aec837.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d82d7ac8ea9e8f306e1040b50c9d73c1\" alt=\"Untitled (1).png\"\u002F\u003E\u003C\u002Fa\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003E以下は具体的にmasterブランチにマージされた際のCircleCIのワークフローになります。\u003Cbr\u003E\u003Ca href=\"https:\u002F\u002Fqiita-user-contents.imgix.net\u002Fhttps%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Fd3e01c16-81ca-4789-b42f-0cc736c7f6e3.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=fedb744ae5c8d54a4e1f5e9cde3a21a7\" target=\"_blank\" rel=\"noreferrer noopener\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\n\n\u003Cfigure class=\"wp-block-image\"\u003E\u003Ca href=\"https:\u002F\u002Fqiita-user-contents.imgix.net\u002Fhttps%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Fd3e01c16-81ca-4789-b42f-0cc736c7f6e3.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=fedb744ae5c8d54a4e1f5e9cde3a21a7\" target=\"_blank\" rel=\"noreferrer noopener\"\u003E\u003Cimg decoding=\"async\" src=\"https:\u002F\u002Fqiita-user-contents.imgix.net\u002Fhttps%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F65478%2Fd3e01c16-81ca-4789-b42f-0cc736c7f6e3.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=fedb744ae5c8d54a4e1f5e9cde3a21a7\" alt=\"スクリーンショット 2020-05-11 8.54.15.png\"\u002F\u003E\u003C\u002Fa\u003E\u003C\u002Ffigure\u003E\n\n\n\n\u003Cp\u003E以下のような順でワークフローを定義しています。\u003Cbr\u003E1. 環境のセットアップ\u003Cbr\u003E2. Lintによる構文チェック\u003Cbr\u003E3. ユニットテスト\u003Cbr\u003E4. インテグレーションテスト\u003Cbr\u003E5. ステージングへのデプロイ\u003C\u002Fp\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eまとめ\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003E以上でディレクトリ構成からテストやデプロイまでの方針の考え方を述べてきました。\u003Cbr\u003Eこのようにすることで複数のスタックから構成される大規模なサーバーレスアプリケーションでもスッキリと構成管理を行って運用することが出来ます。\u003Cbr\u003E是非皆さんもこれを参考にサーバーレスアーキテクチャの導入にチャレンジしてもらえるとうれしいです。\u003C\u002Fp\u003E\n","author":{"name":"Takahiro Horike","description":"Co-founder and CEO of Serverless Operations, Inc","avatars":{"avatar96":"https:\u002F\u002Fsecure.gravatar.com\u002Favatar\u002F2ee9db3a5b6c492acf66ec14c8a5d8dc?s=96&d=mm&r=g"},"acf":{"userJpName":"堀家 隆宏","userRole":"CEO","facebook":"https:\u002F\u002Fwww.facebook.com\u002Fhorike.takahiro","twitter":"https:\u002F\u002Ftwitter.com\u002Fhorike37","github":"https:\u002F\u002Fgithub.com\u002Fhorike37"}},"date":"2020.05.11","path":"\u002Fblog\u002F26\u002F","featuredMedia":{"sourceUrl":"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2020\u002F05\u002Fhttps___qiita-image-store.s3.ap-northeast-1.amazonaws.com_0_65478_8c340426-2aa6-94e1-469d-1684569d9809.png","altText":"","mediaDetails":{"width":816}},"categories":[{"id":"7","title":"Blog","path":"\u002Fcategory\u002Fblog\u002F"}],"tags":[{"id":"8","title":"AWS","path":"\u002Ftag\u002Faws\u002F"},{"id":"2","title":"Serverless","path":"\u002Ftag\u002Fserverless\u002F"}]},"metadata":{"siteName":"Serverless Operations","siteDescription":"Serverless Operationsは、これまでグローバルの第一線で培ってきたクラウド技術（AWS − アマゾンウェブサービス）の豊富な実績と知見を活かし、お客さまのサーバーレスによる開発や運用の支援、コンサルティングまで一貫してサポート。サーバーレスに関するさまざまな課題を解決いたします。","siteUrl":"https:\u002F\u002Fserverless.co.jp","siteOgImage":"https:\u002F\u002Fserverless.co.jp\u002Fogp.png"}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.f355efd1.js" defer></script><script src="/assets/js/page--src--templates--word-press-blog-vue.fdf3ed1a.js" defer></script><script data-vue-tag="ssr" src="https://webfont.fontplus.jp/accessor/script/fontplus.js?LuMx0zy9taw%3D&box=ME4Rs88c3-0%3D&aa=1&ab=2" data-body="true"></script>
  </body>
</html>
