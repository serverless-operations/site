<!DOCTYPE html>
<html data-html-server-rendered="true" lang="ja" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22ja%22%7D%7D">
  <head>
    <title>stripe を使って定期料金と従量課金を組み合わせたサブスクリプション型サービスを作る | Serverless Operations</title><meta name="gridsome:hash" content="7f941d81843b6b274431cd2b599fad9eb656e895"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.14"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="og:locale" property="og:locale" content="ja_JP"><meta data-vue-tag="ssr" data-key="og:site_name" property="og:site_name" content="Serverless Operations"><meta data-vue-tag="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" name="twitter:image" content="https://serverless.co.jp/ogp.png"><meta data-vue-tag="ssr" data-key="og:type" property="og:type" content="article"><meta data-vue-tag="ssr" data-key="og:url" property="og:url" content="https://serverless.co.jp/blog/337/"><meta data-vue-tag="ssr" data-key="og:image" property="og:image" content="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/05/so-release.png"><meta data-vue-tag="ssr" data-key="og:title" property="og:title" content="stripe を使って定期料金と従量課金を組み合わせたサブスクリプション型サービスを作る | Serverless Operations"><meta data-vue-tag="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" name="twitter:image" content="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/05/so-release.png"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css"><link data-vue-tag="ssr" data-key="canonical" rel="canonical" href="https://serverless.co.jp/blog/337/"><link rel="preload" href="/assets/css/0.styles.6e17c92a.css" as="style"><link rel="preload" href="/assets/js/app.c763dd48.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--word-press-blog-vue.ed359a1f.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules--gridsome--app--pages--404-vue.f0ef102d.js"><link rel="prefetch" href="/assets/js/page--src--pages--about-vue.832deef9.js"><link rel="prefetch" href="/assets/js/page--src--pages--blog-archives-vue.1ef8c3a8.js"><link rel="prefetch" href="/assets/js/page--src--pages--contact-vue.a038f445.js"><link rel="prefetch" href="/assets/js/page--src--pages--download-vue.64eb66c2.js"><link rel="prefetch" href="/assets/js/page--src--pages--event-archives-vue.2fc3f372.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.0ebce967.js"><link rel="prefetch" href="/assets/js/page--src--pages--news-archives-vue.fb6672ae.js"><link rel="prefetch" href="/assets/js/page--src--pages--our-products-vue.fde3a04c.js"><link rel="prefetch" href="/assets/js/page--src--pages--privacy-policy-vue.6ff4c5d2.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--aws-serverless-vue.eeeffcda.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--aws-serverless-vue~page--src--pages--services--iot-serverless-vue.bada637e.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--index-vue.661d8bc2.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--iot-serverless-vue.71225155.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--serverless-consulting-vue.e79734fa.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--serverless-development-vue.72b00987.js"><link rel="prefetch" href="/assets/js/page--src--pages--test-form-vue.890dafea.js"><link rel="prefetch" href="/assets/js/page--src--pages--works-archives-vue.10254f8e.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-category-vue.bff3e9ed.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-post-tag-vue.caedd45d.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-post-vue.7504cc09.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-works-vue.8a12c84e.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--contact-vue~page--src--pages--download-vue.7a23cb3f.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--our-products-vue.8e9052c2.js"><link rel="prefetch" href="/assets/js/vendors~page--src--templates--word-press-blog-vue.16b09ab1.js"><link rel="stylesheet" href="/assets/css/0.styles.6e17c92a.css"><script data-vue-tag="ssr">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-MLP4448');</script><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div id="app" data-server-rendered="true" class="v-application v-application--is-ltr theme--dark" data-v-7de3dd27><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MLP4448" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="v-application--wrap"><header class="header-nav" data-v-5f4f5539><div class="header-nav__logo-block" data-v-5f4f5539><a href="/" class="header-nav__logo-link active" data-v-5f4f5539><img src="/assets/img/header-logo.a93f880b.svg" alt="Severless Operations ロゴ" class="header-nav__logo" data-v-5f4f5539></a></div><nav data-v-5f4f5539><ul data-v-5f4f5539><li data-v-5f4f5539><a href="/about" data-v-5f4f5539>私たちについて</a></li><li data-v-5f4f5539><a href="/services" data-v-5f4f5539>サービス</a></li><li data-v-5f4f5539><a href="/works-archives" data-v-5f4f5539>実績紹介</a></li><li data-v-5f4f5539><a href="/blog-archives" data-v-5f4f5539>ブログ</a></li><li data-v-5f4f5539><a href="/news-archives" data-v-5f4f5539>お知らせ</a></li><li data-v-5f4f5539><a href="/download" data-v-5f4f5539>会社資料ダウンロード</a></li><li data-v-5f4f5539><a href="/contact" data-v-5f4f5539>お問い合わせ</a></li></ul></nav><div id="app" class="header-nav__toggler-block d-block d-md-none" data-v-5f4f5539><button id="btn" type="button" class="header-nav__toggler-button btn" data-v-5f4f5539><div tabindex="-1" class="btn__content" data-v-5f4f5539><span class="header-nav__toggler-top" data-v-5f4f5539></span><span class="header-nav__toggler-middle" data-v-5f4f5539></span><span class="header-nav__toggler-bottom" data-v-5f4f5539></span></div></button></div><!----></header><main class="v-content"><div class="v-content" data-v-7de3dd27><div class="v-content__wrap" data-v-7de3dd27><div class="container" data-v-7de3dd27><p class="category-title" data-v-7de3dd27>
          Blog
        </p></div><header class="post-header" data-v-7de3dd27><div class="container" data-v-7de3dd27><div class="row justify-center" data-v-7de3dd27><div class="col-md-10 col-11" data-v-7de3dd27><h1 class="post-title" data-v-7de3dd27>stripe を使って定期料金と従量課金を組み合わせたサブスクリプション型サービスを作る</h1><div class="post-tag-container" data-v-7de3dd27><time datetime="2021.03.08" class="post-date" data-v-7de3dd27> 
                  2021.03.08
                  
                </time><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>node.js</span></div><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>pricing</span></div><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>SaaS</span></div><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>Stripe</span></div><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>subscription</span></div></div></div></div></div></header><article class="post-container" data-v-7de3dd27><div class="container" data-v-7de3dd27><div class="row justify-center" data-v-7de3dd27><div class="post-article-container col-md-10 col-11" data-v-7de3dd27><div class="post-article" data-v-7de3dd27>
<p>決済サービスで有名な stripe ですが、高機能かつ使いやすく、導入事例も増えてきています。この頃特に関心が高まってきたサブスクリプション型の料金体系についても豊富な機能が提供されており、これをきっかけに stripe を導入することも決めたプロジェクトも多いのではないでしょうか。</p>



<p>今回は、stripe を使って定額・定期購入のサブスクリプション及び利用量に応じて金額が変動する従量課金の両方を組み合わせた料金体型について、実現方法をまとめました。</p>



<h2 class="wp-block-heading">サンプルの商品を登録する</h2>



<p>stripe ダッシュボードにて、以下のようにサンプルの商品を登録します。<br>① Sandbox &#8211; Basic Plan：一般的な定額・定期購入タイプのサービス利用プラ<br>② Sandbox &#8211; API Usage：API 呼び出し回数等、従量課金の利用プラン</p>



<div class="wp-block-image"><figure class="alignleft size-large is-resized"><img decoding="async" loading="lazy" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-14.52.16.png" alt="" class="wp-image-338" width="600" height="623" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-14.52.16.png 600w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-14.52.16-289x300.png 289w" sizes="(max-width: 600px) 100vw, 600px" /><figcaption>① Sandbox &#8211; Basic Plan</figcaption></figure></div>



<figure class="wp-block-image size-large is-resized"><img decoding="async" loading="lazy" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-14.55.50.png" alt="" class="wp-image-339" width="600" height="605" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-14.55.50.png 600w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-14.55.50-298x300.png 298w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-14.55.50-150x150.png 150w" sizes="(max-width: 600px) 100vw, 600px" /><figcaption>② Sandbox &#8211; API Usage</figcaption></figure>



<p>今回のサンプルについては、① Sandbox &#8211; Basic Plan に「Pricing model: Standard pricing（標準の料金体系）」を指定、② Sandbox &#8211; API Usage に「Pricing model: Graduated pricing（段階的な料金体系）」を指定します。</p>



<p>従量課金向けの料金体系としては「段階的」と「数量ベース」の２種類があります。一定数の段階を設けて各段階ごとに異なる単価を適用する場合は「段階的」、利用量の合計に応じて全体に対し異なる単価を適用する場合は「数量ベース」となります。</p>



<p>例えば１ユニットあたりの金額を算定する方式として</p>



<ul><li>「1-100回目は○○円、101-200回目は○○円」と段階的に異なる料金を積み上げていく（段階式）</li><li>「合計回数100回以下の場合○○円、合計回数200回以下の場合は○○円、合計回数が201回以上の場合は○○円」と合計数ベースで単価を決める（数量ベース）</li></ul>



<p>という使い分けが可能になります。</p>



<p>stripe のダッシュボードではこういった金額算定の詳細が直感的に設定できるようになっていて、たとえ商品の課金構造が複雑であってもこのような細かいルールを自前で実装する必要がなくなります。</p>



<p>引き続き、請求期間を「月次」、また従量課金の商品については「Usage is metered（使用量が計測されます）」にチェックを入れます。</p>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img decoding="async" loading="lazy" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-14.56.08.png" alt="" class="wp-image-340" width="300" height="332" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-14.56.08.png 600w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-14.56.08-271x300.png 271w" sizes="(max-width: 300px) 100vw, 300px" /></figure></div>



<p>「Usage is metered（使用量が計測されます）」にチェックを入れることで、後ほど説明する「使用量の報告」ができるようになります。実際に各ユーザーの使用量を stripe の API 経由でレポートするだけで、商品登録時に設定した料金テーブルに合わせて課金額が計算されます。</p>



<p>「Charge for metered usage by（計測された使用量に基づく請求）」については、適宜ユースケースやシステム仕様に合わせて選択すると良いと思います。</p>



<h2 class="wp-block-heading">顧客及びサブスクリプションの登録</h2>



<p>サンプルで利用する顧客、支払情報、サブスクリプションを登録します。決済登録画面のデモは公式の Checkout サンプルを利用します。</p>



<p><a href="https://stripe.com/docs/billing/subscriptions/checkout">https://stripe.com/docs/billing/subscriptions/checkout</a></p>



<p>GitHub にサンプルがあるのでクローンし、以下のように修正します。Price ID については先程登録した商品の画面から <code>price_xxx</code> という値をコピーして適用します。</p>



<pre class="wp-block-code language-javascript"><code>// https://github.com/stripe-samples/checkout-single-subscription
// server/node/server.js L.50 -
const session = await stripe.checkout.sessions.create({
  mode: 'subscription',
  payment_method_types: &#91; 'card' ],
  line_items: &#91;
    { price: '{PRICE_ID_PLAN}', quantity: 1 },
    { price: '{PRICE_ID_API_USAGE}' }
  ],
// ...</code></pre>



<p>また、server/node に .env ファイルを作成しAPIキー等を以下のようにセットしておきます。</p>



<pre class="wp-block-code language-bash"><code># Stripe keys
STRIPE_PUBLISHABLE_KEY={PUBLISHABLE_KEY}
STRIPE_SECRET_KEY={SECRET_KEY}

# Environment
STATIC_DIR=../../client

# Stripe subscription data
DOMAIN=http://localhost:4242</code></pre>



<p>README.md の Instruction に従い、以下のようにサンプルアプリ実行します。</p>



<pre class="wp-block-code language-bash"><code>cd server/node # there's a README in this folder with instructions
npm install
npm run start</code></pre>



<p>サンプルアプリが立ち上がったらブラウザを起動し、最初の画面はダミーなのでどちらかの「Select」を押してスキップ、登録画面に進むと、先程登録した２つの商品（定額課金・従量課金）が表示されています。</p>



<figure class="wp-block-image size-large"><img decoding="async" loading="lazy" width="1024" height="643" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-15.03.45-1024x643.png" alt="" class="wp-image-341" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-15.03.45-1024x643.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-15.03.45-300x189.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-15.03.45-768x483.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-15.03.45.png 1200w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>※カード番号は stripe テストモード専用の番号です。</p>



<p>各項目を埋めて Subscribe ボタンを押して登録、stripe のダッシュボードで確認すると、顧客とサブスクリプション情報が登録されていることが分かります。さらに、「定期支払」項目より請求情報の詳細が確認できます。通常の定額課金については、ここまでで先ずOKとなります。</p>



<figure class="wp-block-image size-large"><img decoding="async" loading="lazy" width="1000" height="474" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-15.07.21.png" alt="" class="wp-image-342" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-15.07.21.png 1000w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-15.07.21-300x142.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-15.07.21-768x364.png 768w" sizes="(max-width: 1000px) 100vw, 1000px" /></figure>



<h2 class="wp-block-heading">従量課金の使用量を報告する</h2>



<p>最後に、実際に従量課金（Metered Billing）の金額を反映させるために、顧客が利用した量（ユニット）を数値として stripe に送信する必要があります。その時に使えるのが、Usage Records API です。Path パラメータに顧客の定期支払のダッシュボード画面から取得できる「サブスクリプションアイテムID（<code>si_xxx</code>）」を指定して数量を送信する形となります。</p>



<pre class="wp-block-code language-bash"><code>&#91;request sample]
POST /v1/subscription_items/:subscription_item_id/usage_records
authorization: Bearer {SECRET_API_KEY}
content-type: application/x-www-form-urlencoded

timestamp=1614752111&amp;quantity=250&amp;action=set

&#91;response sample]
200 OK
{
  "subscription_item": "xxx",
  "quantity": 250,
  "timestamp": 1615097751,
  // ...
}</code></pre>



<p>すると、このように使用量が請求情報に反映されることが確認できます。</p>



<figure class="wp-block-image size-large"><img decoding="async" loading="lazy" width="1000" height="555" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-15.19.59.png" alt="" class="wp-image-343" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-15.19.59.png 1000w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-15.19.59-300x167.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen-Shot-2021-03-07-at-15.19.59-768x426.png 768w" sizes="(max-width: 1000px) 100vw, 1000px" /></figure>



<h2 class="wp-block-heading">アドホックに請求項目と金額を追加する方法もある</h2>



<p>サブスクリプションの期間中に次回の請求項目を随時追加できるAPIもあります。減額も可能なので、アドホックに次回請求の金額を調節・精算するといった使い方も可能です。</p>



<p><a href="https://stripe.com/docs/billing/invoices/subscription#adding-upcoming-invoice-items">https://stripe.com/docs/billing/invoices/subscription#adding-upcoming-invoice-items</a></p>



<figure class="wp-block-image size-large"><img decoding="async" loading="lazy" width="1024" height="210" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen_Shot_2021-02-08_at_18.55.32-1024x210.png" alt="" class="wp-image-344" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen_Shot_2021-02-08_at_18.55.32-1024x210.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen_Shot_2021-02-08_at_18.55.32-300x62.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen_Shot_2021-02-08_at_18.55.32-768x158.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen_Shot_2021-02-08_at_18.55.32-1536x315.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/03/Screen_Shot_2021-02-08_at_18.55.32.png 1812w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<h2 class="wp-block-heading">まとめ</h2>



<ul><li>stripe を利用して、通常の定期購入に加え、従量課金もセットで課金体系を構築することが可能です。</li><li>従量課金については商品登録時に予め料金体系を設定し、使用量を送信することで料金に反映させます。</li><li>こうすることで従量課金に伴う課金ロジックを自前で実装する必要がなく、stripe 側にまるっとおまかせできるメリットがあります。</li></ul>
</div><section class="l-share-button" data-v-629ec8b5 data-v-7de3dd27><aside class="p-share-button" data-v-629ec8b5><div class="p-share-button__header" data-v-629ec8b5>SHARE</div><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fserverless.co.jp%2Fblog%2F337%2F" target="_blank" title="Facebookでシェア" class="p-share-button__link--facebook " data-v-629ec8b5><i class="mdi mdi-facebook" data-v-629ec8b5></i></a><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fserverless.co.jp%2Fblog%2F337%2F&amp;text=stripe%20%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E5%AE%9A%E6%9C%9F%E6%96%99%E9%87%91%E3%81%A8%E5%BE%93%E9%87%8F%E8%AA%B2%E9%87%91%E3%82%92%E7%B5%84%E3%81%BF%E5%90%88%E3%82%8F%E3%81%9B%E3%81%9F%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E5%9E%8B%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%82%92%E4%BD%9C%E3%82%8B" target="_blank" title="Twitterでシェア" class="p-share-button__link--twitter" data-v-629ec8b5><i class="mdi mdi-twitter" data-v-629ec8b5></i></a></aside></section><div class="post-author-container" data-v-7de3dd27><h5 class="post-author-title" data-v-7de3dd27>Written by</h5><div class="post-author-text" data-v-7de3dd27><p data-v-7de3dd27><span class="role" data-v-7de3dd27>
                      COO
                    </span><span class="name-jp" data-v-7de3dd27>
                      金 仙優
                    </span><span class="name-en" data-v-7de3dd27>
                      Sonu Kim
                    </span></p><p class="author-desc" data-v-7de3dd27>
                    
                  </p><ul class="author-sns" data-v-7de3dd27><li data-v-7de3dd27><!----></li><li data-v-7de3dd27><!----></li><li data-v-7de3dd27><!----></li></ul></div></div></div></div></div><div class="p-news-bg" data-v-7de3dd27></div></article><div class="container" data-v-7de3dd27><div class="row justify-center" data-v-7de3dd27><a href="/blog-archives" class="post-archives-link" data-v-7de3dd27><span class="post-archives-link-text" data-v-7de3dd27>BACK TO LIST</span><span data-v-7de3dd27><img src="/assets/img/icon-back-to-list.3add3700.svg" alt="BACK TO LIST アイコン" data-v-7de3dd27></span></a></div></div></div></div></main><footer class="v-footer footer v-sheet v-sheet--tile theme--dark" data-v-a49f4c2c><div class="container" data-v-a49f4c2c data-v-a49f4c2c><div class="row" data-v-a49f4c2c data-v-a49f4c2c><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><a href="/works-archives" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>Works</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>実績紹介</div></a><ul class="c-footer-list" data-v-a49f4c2c><div data-v-b68eaa08 data-v-a49f4c2c><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/501/" class="c-footer-list__link" data-v-b68eaa08>
      戸田建設株式会社
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/396/" class="c-footer-list__link" data-v-b68eaa08>
      北海道テレビ放送株式会社
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/358/" class="c-footer-list__link" data-v-b68eaa08>
      株式会社Geolonia
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/24/" class="c-footer-list__link" data-v-b68eaa08>
      株式会社LIXIL
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/185/" class="c-footer-list__link" data-v-b68eaa08>
      株式会社TOKION
    </a></li></div></ul></div><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><div data-v-a49f4c2c><a href="/services" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>Services</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>サービス紹介</div></a></div><ul class="c-footer-list" data-v-a49f4c2c><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services" class="c-footer-list__link" data-v-a49f4c2c>サーバーレスオペレーションズの<br data-v-a49f4c2c>サービスと強み</a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/iot-serverless" class="c-footer-list__link" data-v-a49f4c2c>
              IoT × サーバーレス / コンテナ開発<br data-v-a49f4c2c>導⼊サポート
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/aws-serverless" class="c-footer-list__link" data-v-a49f4c2c>
              AWSコアサーバーレスサービスの開発導⼊サポート
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/serverless-consulting" class="c-footer-list__link" data-v-a49f4c2c>サーバーレスコンサルティング</a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/serverless-development" class="c-footer-list__link" data-v-a49f4c2c>サーバーレスディべロプメント</a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/our-products" class="c-footer-list__link" data-v-a49f4c2c>
              自社開発プロダクト
            </a></li></ul></div><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><a href="/blog-archives" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>Blog</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>開発ブログ</div></a><ul class="c-footer-list" data-v-a49f4c2c><div data-v-39434060 data-v-a49f4c2c><li class="c-footer-list__item" data-v-39434060><a href="/blog/640/" class="c-footer-list__link" data-v-39434060>
      AWS 開発基盤として、セキュリティを考慮したマルチアカウント構成のススメ
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/532/" class="c-footer-list__link" data-v-39434060>
      AWS Amplify GraphQL Transformer v2 のデータモデリングとリレーションの仕組みを解説する
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/512/" class="c-footer-list__link" data-v-39434060>
      AWS Lambda + Nuxt3で実現する「サーバーレスなSSR」とその構成
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/25/" class="c-footer-list__link" data-v-39434060>
      Serverless Frameworkの使い方まとめ
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/450/" class="c-footer-list__link" data-v-39434060>
      軽量で簡単に使えるキャッシュSaaS、MomentoをAWS Lambdaから使ってみる
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/429/" class="c-footer-list__link" data-v-39434060>
      Next.js アプリケーションを AWS Amplify でホスティングする上でのTIPS
    </a></li></div></ul></div><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><a href="/about" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>About</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>会社案内</div></a><ul class="c-footer-list" data-v-a49f4c2c><li class="c-footer-list__item" data-v-a49f4c2c><a href="/about" class="c-footer-list__link" data-v-a49f4c2c>
              会社案内
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/news-archives/" class="c-footer-list__link" data-v-a49f4c2c>
              おしらせ
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/privacy-policy/" class="c-footer-list__link" data-v-a49f4c2c>
              プライバシーポリシー
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/download" class="c-footer-list__link" data-v-a49f4c2c>
              会社資料ダウンロード
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/contact" class="c-footer-list__link" data-v-a49f4c2c>
              お問い合わせ
            </a></li></ul></div></div><div class="row mt-8 mt-md-12" data-v-a49f4c2c data-v-a49f4c2c><div class="col-md-2 col-12" data-v-a49f4c2c data-v-a49f4c2c><div data-v-a49f4c2c><a href="/" class="active" data-v-a49f4c2c><img src="/assets/img/footer-severless-operations-logo.e1e6687a.svg" alt="Severless Operations ロゴ" data-v-a49f4c2c></a></div></div><div class="col-md-10 col-12" data-v-a49f4c2c data-v-a49f4c2c><div class="sns-link text-md-right" data-v-a49f4c2c><a href="https://github.com/serverless-operations" target="_blank" class="sns-link__github" data-v-a49f4c2c><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" data-v-a49f4c2c></i></a><a href="https://twitter.com/slsopsinc" target="_blank" class="sns-link__twitter" data-v-a49f4c2c><i aria-hidden="true" class="v-icon notranslate mdi mdi-twitter theme--light" data-v-a49f4c2c></i></a></div></div><div class="footer-copyright" data-v-a49f4c2c>
        © Serverless Operations, inc
      </div></div></div></footer></div></div>
    <script>window.__INITIAL_STATE__={"data":{"wordPressBlog":{"title":"stripe を使って定期料金と従量課金を組み合わせたサブスクリプション型サービスを作る","content":"\n\u003Cp\u003E決済サービスで有名な stripe ですが、高機能かつ使いやすく、導入事例も増えてきています。この頃特に関心が高まってきたサブスクリプション型の料金体系についても豊富な機能が提供されており、これをきっかけに stripe を導入することも決めたプロジェクトも多いのではないでしょうか。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E今回は、stripe を使って定額・定期購入のサブスクリプション及び利用量に応じて金額が変動する従量課金の両方を組み合わせた料金体型について、実現方法をまとめました。\u003C\u002Fp\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eサンプルの商品を登録する\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003Estripe ダッシュボードにて、以下のようにサンプルの商品を登録します。\u003Cbr\u003E① Sandbox &#8211; Basic Plan：一般的な定額・定期購入タイプのサービス利用プラ\u003Cbr\u003E② Sandbox &#8211; API Usage：API 呼び出し回数等、従量課金の利用プラン\u003C\u002Fp\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"alignleft size-large is-resized\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-14.52.16.png\" alt=\"\" class=\"wp-image-338\" width=\"600\" height=\"623\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-14.52.16.png 600w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-14.52.16-289x300.png 289w\" sizes=\"(max-width: 600px) 100vw, 600px\" \u002F\u003E\u003Cfigcaption\u003E① Sandbox &#8211; Basic Plan\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Cfigure class=\"wp-block-image size-large is-resized\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-14.55.50.png\" alt=\"\" class=\"wp-image-339\" width=\"600\" height=\"605\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-14.55.50.png 600w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-14.55.50-298x300.png 298w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-14.55.50-150x150.png 150w\" sizes=\"(max-width: 600px) 100vw, 600px\" \u002F\u003E\u003Cfigcaption\u003E② Sandbox &#8211; API Usage\u003C\u002Ffigcaption\u003E\u003C\u002Ffigure\u003E\n\n\n\n\u003Cp\u003E今回のサンプルについては、① Sandbox &#8211; Basic Plan に「Pricing model: Standard pricing（標準の料金体系）」を指定、② Sandbox &#8211; API Usage に「Pricing model: Graduated pricing（段階的な料金体系）」を指定します。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E従量課金向けの料金体系としては「段階的」と「数量ベース」の２種類があります。一定数の段階を設けて各段階ごとに異なる単価を適用する場合は「段階的」、利用量の合計に応じて全体に対し異なる単価を適用する場合は「数量ベース」となります。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E例えば１ユニットあたりの金額を算定する方式として\u003C\u002Fp\u003E\n\n\n\n\u003Cul\u003E\u003Cli\u003E「1-100回目は○○円、101-200回目は○○円」と段階的に異なる料金を積み上げていく（段階式）\u003C\u002Fli\u003E\u003Cli\u003E「合計回数100回以下の場合○○円、合計回数200回以下の場合は○○円、合計回数が201回以上の場合は○○円」と合計数ベースで単価を決める（数量ベース）\u003C\u002Fli\u003E\u003C\u002Ful\u003E\n\n\n\n\u003Cp\u003Eという使い分けが可能になります。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Estripe のダッシュボードではこういった金額算定の詳細が直感的に設定できるようになっていて、たとえ商品の課金構造が複雑であってもこのような細かいルールを自前で実装する必要がなくなります。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E引き続き、請求期間を「月次」、また従量課金の商品については「Usage is metered（使用量が計測されます）」にチェックを入れます。\u003C\u002Fp\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"aligncenter size-large is-resized\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-14.56.08.png\" alt=\"\" class=\"wp-image-340\" width=\"300\" height=\"332\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-14.56.08.png 600w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-14.56.08-271x300.png 271w\" sizes=\"(max-width: 300px) 100vw, 300px\" \u002F\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003E「Usage is metered（使用量が計測されます）」にチェックを入れることで、後ほど説明する「使用量の報告」ができるようになります。実際に各ユーザーの使用量を stripe の API 経由でレポートするだけで、商品登録時に設定した料金テーブルに合わせて課金額が計算されます。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E「Charge for metered usage by（計測された使用量に基づく請求）」については、適宜ユースケースやシステム仕様に合わせて選択すると良いと思います。\u003C\u002Fp\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003E顧客及びサブスクリプションの登録\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003Eサンプルで利用する顧客、支払情報、サブスクリプションを登録します。決済登録画面のデモは公式の Checkout サンプルを利用します。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fbilling\u002Fsubscriptions\u002Fcheckout\"\u003Ehttps:\u002F\u002Fstripe.com\u002Fdocs\u002Fbilling\u002Fsubscriptions\u002Fcheckout\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003EGitHub にサンプルがあるのでクローンし、以下のように修正します。Price ID については先程登録した商品の画面から \u003Ccode\u003Eprice_xxx\u003C\u002Fcode\u003E という値をコピーして適用します。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-javascript\"\u003E\u003Ccode\u003E\u002F\u002F https:\u002F\u002Fgithub.com\u002Fstripe-samples\u002Fcheckout-single-subscription\n\u002F\u002F server\u002Fnode\u002Fserver.js L.50 -\nconst session = await stripe.checkout.sessions.create({\n  mode: 'subscription',\n  payment_method_types: &#91; 'card' ],\n  line_items: &#91;\n    { price: '{PRICE_ID_PLAN}', quantity: 1 },\n    { price: '{PRICE_ID_API_USAGE}' }\n  ],\n\u002F\u002F ...\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003Eまた、server\u002Fnode に .env ファイルを作成しAPIキー等を以下のようにセットしておきます。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-bash\"\u003E\u003Ccode\u003E# Stripe keys\nSTRIPE_PUBLISHABLE_KEY={PUBLISHABLE_KEY}\nSTRIPE_SECRET_KEY={SECRET_KEY}\n\n# Environment\nSTATIC_DIR=..\u002F..\u002Fclient\n\n# Stripe subscription data\nDOMAIN=http:\u002F\u002Flocalhost:4242\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003EREADME.md の Instruction に従い、以下のようにサンプルアプリ実行します。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-bash\"\u003E\u003Ccode\u003Ecd server\u002Fnode # there's a README in this folder with instructions\nnpm install\nnpm run start\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003Eサンプルアプリが立ち上がったらブラウザを起動し、最初の画面はダミーなのでどちらかの「Select」を押してスキップ、登録画面に進むと、先程登録した２つの商品（定額課金・従量課金）が表示されています。\u003C\u002Fp\u003E\n\n\n\n\u003Cfigure class=\"wp-block-image size-large\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"643\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-15.03.45-1024x643.png\" alt=\"\" class=\"wp-image-341\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-15.03.45-1024x643.png 1024w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-15.03.45-300x189.png 300w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-15.03.45-768x483.png 768w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-15.03.45.png 1200w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \u002F\u003E\u003C\u002Ffigure\u003E\n\n\n\n\u003Cp\u003E※カード番号は stripe テストモード専用の番号です。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E各項目を埋めて Subscribe ボタンを押して登録、stripe のダッシュボードで確認すると、顧客とサブスクリプション情報が登録されていることが分かります。さらに、「定期支払」項目より請求情報の詳細が確認できます。通常の定額課金については、ここまでで先ずOKとなります。\u003C\u002Fp\u003E\n\n\n\n\u003Cfigure class=\"wp-block-image size-large\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" width=\"1000\" height=\"474\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-15.07.21.png\" alt=\"\" class=\"wp-image-342\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-15.07.21.png 1000w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-15.07.21-300x142.png 300w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-15.07.21-768x364.png 768w\" sizes=\"(max-width: 1000px) 100vw, 1000px\" \u002F\u003E\u003C\u002Ffigure\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003E従量課金の使用量を報告する\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003E最後に、実際に従量課金（Metered Billing）の金額を反映させるために、顧客が利用した量（ユニット）を数値として stripe に送信する必要があります。その時に使えるのが、Usage Records API です。Path パラメータに顧客の定期支払のダッシュボード画面から取得できる「サブスクリプションアイテムID（\u003Ccode\u003Esi_xxx\u003C\u002Fcode\u003E）」を指定して数量を送信する形となります。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-bash\"\u003E\u003Ccode\u003E&#91;request sample]\nPOST \u002Fv1\u002Fsubscription_items\u002F:subscription_item_id\u002Fusage_records\nauthorization: Bearer {SECRET_API_KEY}\ncontent-type: application\u002Fx-www-form-urlencoded\n\ntimestamp=1614752111&amp;quantity=250&amp;action=set\n\n&#91;response sample]\n200 OK\n{\n  \"subscription_item\": \"xxx\",\n  \"quantity\": 250,\n  \"timestamp\": 1615097751,\n  \u002F\u002F ...\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003Eすると、このように使用量が請求情報に反映されることが確認できます。\u003C\u002Fp\u003E\n\n\n\n\u003Cfigure class=\"wp-block-image size-large\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" width=\"1000\" height=\"555\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-15.19.59.png\" alt=\"\" class=\"wp-image-343\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-15.19.59.png 1000w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-15.19.59-300x167.png 300w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen-Shot-2021-03-07-at-15.19.59-768x426.png 768w\" sizes=\"(max-width: 1000px) 100vw, 1000px\" \u002F\u003E\u003C\u002Ffigure\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eアドホックに請求項目と金額を追加する方法もある\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003Eサブスクリプションの期間中に次回の請求項目を随時追加できるAPIもあります。減額も可能なので、アドホックに次回請求の金額を調節・精算するといった使い方も可能です。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fbilling\u002Finvoices\u002Fsubscription#adding-upcoming-invoice-items\"\u003Ehttps:\u002F\u002Fstripe.com\u002Fdocs\u002Fbilling\u002Finvoices\u002Fsubscription#adding-upcoming-invoice-items\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\n\n\u003Cfigure class=\"wp-block-image size-large\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"210\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen_Shot_2021-02-08_at_18.55.32-1024x210.png\" alt=\"\" class=\"wp-image-344\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen_Shot_2021-02-08_at_18.55.32-1024x210.png 1024w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen_Shot_2021-02-08_at_18.55.32-300x62.png 300w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen_Shot_2021-02-08_at_18.55.32-768x158.png 768w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen_Shot_2021-02-08_at_18.55.32-1536x315.png 1536w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2021\u002F03\u002FScreen_Shot_2021-02-08_at_18.55.32.png 1812w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \u002F\u003E\u003C\u002Ffigure\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eまとめ\u003C\u002Fh2\u003E\n\n\n\n\u003Cul\u003E\u003Cli\u003Estripe を利用して、通常の定期購入に加え、従量課金もセットで課金体系を構築することが可能です。\u003C\u002Fli\u003E\u003Cli\u003E従量課金については商品登録時に予め料金体系を設定し、使用量を送信することで料金に反映させます。\u003C\u002Fli\u003E\u003Cli\u003Eこうすることで従量課金に伴う課金ロジックを自前で実装する必要がなく、stripe 側にまるっとおまかせできるメリットがあります。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\n","author":{"name":"Sonu Kim","description":"","avatars":{"avatar96":"https:\u002F\u002Fsecure.gravatar.com\u002Favatar\u002F5b527696e38c84c34048954d767b1537?s=96&d=mm&r=g"},"acf":{"userJpName":"金 仙優","userRole":"COO","facebook":"","twitter":"","github":""}},"date":"2021.03.08","path":"\u002Fblog\u002F337\u002F","featuredMedia":{"sourceUrl":"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2020\u002F05\u002Fso-release.png","altText":"so-release-image","mediaDetails":{"width":1200}},"categories":[{"id":"7","title":"Blog","path":"\u002Fcategory\u002Fblog\u002F"}],"tags":[{"id":"39","title":"node.js","path":"\u002Ftag\u002Fnode-js\u002F"},{"id":"41","title":"pricing","path":"\u002Ftag\u002Fpricing\u002F"},{"id":"34","title":"SaaS","path":"\u002Ftag\u002Fsaas\u002F"},{"id":"20","title":"Stripe","path":"\u002Ftag\u002Fstripe\u002F"},{"id":"38","title":"subscription","path":"\u002Ftag\u002Fsubscription\u002F"}]},"metadata":{"siteName":"Serverless Operations","siteDescription":"Serverless Operationsは、これまでグローバルの第一線で培ってきたクラウド技術（AWS − アマゾンウェブサービス）の豊富な実績と知見を活かし、お客さまのサーバーレスによる開発や運用の支援、コンサルティングまで一貫してサポート。サーバーレスに関するさまざまな課題を解決いたします。","siteUrl":"https:\u002F\u002Fserverless.co.jp","siteOgImage":"https:\u002F\u002Fserverless.co.jp\u002Fogp.png"}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.c763dd48.js" defer></script><script src="/assets/js/page--src--templates--word-press-blog-vue.ed359a1f.js" defer></script><script data-vue-tag="ssr" src="https://webfont.fontplus.jp/accessor/script/fontplus.js?LuMx0zy9taw%3D&box=ME4Rs88c3-0%3D&aa=1&ab=2" data-body="true"></script>
  </body>
</html>
