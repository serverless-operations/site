<!DOCTYPE html>
<html data-html-server-rendered="true" lang="ja" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22ja%22%7D%7D">
  <head>
    <title>AWS Lambda + Nuxt3で実現する「サーバーレスなSSR」とその構成 | Serverless Operations</title><meta name="gridsome:hash" content="7d8cc78e1b8fcf6bb367080efcae4f8df6dfb6c5"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.14"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="og:locale" property="og:locale" content="ja_JP"><meta data-vue-tag="ssr" data-key="og:site_name" property="og:site_name" content="Serverless Operations"><meta data-vue-tag="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" name="twitter:image" content="https://serverless.co.jp/ogp.png"><meta data-vue-tag="ssr" data-key="og:type" property="og:type" content="article"><meta data-vue-tag="ssr" data-key="og:url" property="og:url" content="https://serverless.co.jp/blog/512/"><meta data-vue-tag="ssr" data-key="og:image" property="og:image" content="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/05/so-release.png"><meta data-vue-tag="ssr" data-key="og:title" property="og:title" content="AWS Lambda + Nuxt3で実現する「サーバーレスなSSR」とその構成 | Serverless Operations"><meta data-vue-tag="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" name="twitter:image" content="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/05/so-release.png"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css"><link data-vue-tag="ssr" data-key="canonical" rel="canonical" href="https://serverless.co.jp/blog/512/"><link rel="preload" href="/assets/css/0.styles.98f560c0.css" as="style"><link rel="preload" href="/assets/js/app.748a8736.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--word-press-blog-vue.3139ba43.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules--gridsome--app--pages--404-vue.0efd8db6.js"><link rel="prefetch" href="/assets/js/page--src--pages--about-vue.1af80757.js"><link rel="prefetch" href="/assets/js/page--src--pages--blog-archives-vue.3f2792c8.js"><link rel="prefetch" href="/assets/js/page--src--pages--contact-vue.ff3778ed.js"><link rel="prefetch" href="/assets/js/page--src--pages--download-vue.ed8d75f7.js"><link rel="prefetch" href="/assets/js/page--src--pages--event-archives-vue.020ba0bf.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.be66fc9c.js"><link rel="prefetch" href="/assets/js/page--src--pages--news-archives-vue.d0b081f1.js"><link rel="prefetch" href="/assets/js/page--src--pages--our-products-vue.dc9f52c4.js"><link rel="prefetch" href="/assets/js/page--src--pages--privacy-policy-vue.fdaf6562.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--aws-serverless-vue.b118f419.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--aws-serverless-vue~page--src--pages--services--iot-serverless-vue.bada637e.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--index-vue.45768e68.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--iot-serverless-vue.bbc11f2a.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--serverless-consulting-vue.1e87ce7a.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--serverless-development-vue.4d9baf66.js"><link rel="prefetch" href="/assets/js/page--src--pages--test-form-vue.03f7db27.js"><link rel="prefetch" href="/assets/js/page--src--pages--works-archives-vue.eb99c43a.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-category-vue.d9298a51.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-post-tag-vue.1b66b17a.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-post-vue.808e5e69.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-works-vue.491af2ec.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--contact-vue~page--src--pages--download-vue.7a23cb3f.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--our-products-vue.8e9052c2.js"><link rel="prefetch" href="/assets/js/vendors~page--src--templates--word-press-blog-vue.16b09ab1.js"><link rel="stylesheet" href="/assets/css/0.styles.98f560c0.css"><script data-vue-tag="ssr">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-MLP4448');</script><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div id="app" data-server-rendered="true" class="v-application v-application--is-ltr theme--dark" data-v-7de3dd27><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MLP4448" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="v-application--wrap"><header class="header-nav" data-v-5f4f5539><div class="header-nav__logo-block" data-v-5f4f5539><a href="/" class="header-nav__logo-link active" data-v-5f4f5539><img src="/assets/img/header-logo.a93f880b.svg" alt="Severless Operations ロゴ" class="header-nav__logo" data-v-5f4f5539></a></div><nav data-v-5f4f5539><ul data-v-5f4f5539><li data-v-5f4f5539><a href="/about" data-v-5f4f5539>私たちについて</a></li><li data-v-5f4f5539><a href="/services" data-v-5f4f5539>サービス</a></li><li data-v-5f4f5539><a href="/works-archives" data-v-5f4f5539>実績紹介</a></li><li data-v-5f4f5539><a href="/blog-archives" data-v-5f4f5539>ブログ</a></li><li data-v-5f4f5539><a href="/news-archives" data-v-5f4f5539>お知らせ</a></li><li data-v-5f4f5539><a href="/download" data-v-5f4f5539>会社資料ダウンロード</a></li><li data-v-5f4f5539><a href="/contact" data-v-5f4f5539>お問い合わせ</a></li></ul></nav><div id="app" class="header-nav__toggler-block d-block d-md-none" data-v-5f4f5539><button id="btn" type="button" class="header-nav__toggler-button btn" data-v-5f4f5539><div tabindex="-1" class="btn__content" data-v-5f4f5539><span class="header-nav__toggler-top" data-v-5f4f5539></span><span class="header-nav__toggler-middle" data-v-5f4f5539></span><span class="header-nav__toggler-bottom" data-v-5f4f5539></span></div></button></div><!----></header><main class="v-content"><div class="v-content" data-v-7de3dd27><div class="v-content__wrap" data-v-7de3dd27><div class="container" data-v-7de3dd27><p class="category-title" data-v-7de3dd27>
          Blog
        </p></div><header class="post-header" data-v-7de3dd27><div class="container" data-v-7de3dd27><div class="row justify-center" data-v-7de3dd27><div class="col-md-10 col-11" data-v-7de3dd27><h1 class="post-title" data-v-7de3dd27>AWS Lambda + Nuxt3で実現する「サーバーレスなSSR」とその構成</h1><div class="post-tag-container" data-v-7de3dd27><time datetime="2022.12.14" class="post-date" data-v-7de3dd27> 
                  2022.12.14
                  
                </time><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>AWS Lambda</span></div><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>Nuxt3</span></div><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>Server-side rendering</span></div><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>Serverless</span></div><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>SSR</span></div><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>Vue</span></div></div></div></div></div></header><article class="post-container" data-v-7de3dd27><div class="container" data-v-7de3dd27><div class="row justify-center" data-v-7de3dd27><div class="post-article-container col-md-10 col-11" data-v-7de3dd27><div class="post-article" data-v-7de3dd27>
<p>この記事は<a href="https://qiita.com/advent-calendar/2022/lambda" data-type="URL" data-id="https://qiita.com/advent-calendar/2022/lambda" target="_blank" rel="noreferrer noopener">AWS LambdaとServerless Advent Calendar 2022</a>の15日目の記事です。</p>



<p>フロントエンドの開発トレンドが多様化しています。JSをクライアントのブラウザでのみ実行するCSR（Client-side rendering）及びSPA（Single page application）のような開発構成に続き、近年ではサーバーサイドからJSを利用して動的にHTMLを生成するSSR（Server-side rendering）フレームワークの利用が浸透するようになりました。例えばReactではNext.js、VueではNuxt.jsがあります。</p>



<p>アプリケーションの目的や性質によって適切な技術選定を行うことは当然のことですが、様々なニーズに合わせて自由度高くアプリケーションを開発する必要が出てくることも多いのではないでしょうか。</p>



<p>この記事ではAWS環境での「サーバーレスなSSR」として、AWS Lambda を使って Nuxt3 アプリケーションを動かす構成を紹介します。Next.jsに関してはAWS Amplifyを利用する選択肢がありますが、この記事ではAWS Lambdaを直接指定してビルドとデプロイが可能になった最新のNuxt3を使って説明していきます。</p>



<p>Nuxt2の経験がある方は是非キャッチアップしていただき、Nuxt自体よく分からないという方でも、「コンテナを使わなくても、AWS LambdaでSSRフレームワークが動くのね」という観点で読んでいただけますと幸いです。</p>



<p>この記事を作成している時点（2022/12/14）での最新のNuxt3ではSPA/SSGを想定した静的アセットでのビルドも可能ですが、基本的には Universal Rendering（初回SSR実行、以降CSR）がおすすめです。また、Nuxt3はNitroという新しいエンジンを利用したビルドと実行を行い、ビルドターゲットとしてAWS Lambda がサポートされています。expressに依存せず軽便に扱えるので、エッジコンピューティングの恩恵を受けることも狙いとされています（※<a rel="noreferrer noopener" href="https://nuxt.com/docs/guide/concepts/rendering/#rendering-on-cdn-edge-workers" target="_blank">Rendering on CDN Edge Workers</a>）。</p>



<p>総じてNuxt2のSPAよりも優れた開発経験となることが多いので、是非一度お試しいただければと思います。</p>



<h2 class="wp-block-heading">構成の概要</h2>



<div class="wp-block-image"><figure class="aligncenter size-full is-resized"><img decoding="async" loading="lazy" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/img_1-1.png" alt="" class="wp-image-514" width="549" height="245" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/img_1-1.png 721w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/img_1-1-300x134.png 300w" sizes="(max-width: 549px) 100vw, 549px" /></figure></div>



<p>基本的にはCloudFrontのエンドポイントからリクエストを受け、SSRの実行と静的ファイルのパスを振り分ける対応を行います。Lambdaに関しては今年リリースされたFunction URLを設定することで、シンプルな形としてCloudFrontと連携できます。もしLambdaの機能を使いこなす必要がなく、機能が限定される等の制約を気にしなくて良い場合、Lambda@Edgeでレンダリングを行う構成もあります。</p>



<div class="wp-block-image"><figure class="aligncenter size-full"><img decoding="async" loading="lazy" width="521" height="221" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/img_2-1.png" alt="" class="wp-image-516" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/img_2-1.png 521w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/img_2-1-300x127.png 300w" sizes="(max-width: 521px) 100vw, 521px" /></figure></div>



<p>また、API Gateway のエンドポイントを利用するパターンがあります。開発するアプリケーションによっては、CloudFront を置くほどのものでもなかったり、クライアント証明を導入する必要があったり、細かいアクセス制御を行いたいケースがあります。具体的には空ページを１枚挟んでアプリ間連携を行ったり、ちょっとした設定を行う１枚画面などのユースケースもあるかと思います。</p>



<p>Lambdaから直接静的ファイルのアセットを配信することも可能で、REST API・HTTP API 両方のモードで動作します。Lambda proxy integration で統合することで特別な設定を行わなくてもつながるので、最も構築が簡単な構成になります。</p>



<h2 class="wp-block-heading">Nuxt3 アプリケーションを準備する</h2>



<p>それでは、実際に構築を行ってみます。まずはサンプルとなるNuxt3アプリケーションのプロジェクトを生成します。</p>



<pre class="wp-block-code language-shellsession"><code>npx nuxi init sample-lambda-ssr-project</code></pre>



<p><code>nuxt.config.ts</code> にビルド設定を追記します。nuxt2 を使われた経験がある方は馴染みのある設定ファイルではないでしょうか。個人的にはここで <code>aws-lambda</code> という設定が書けるだけでもテンションが上りました(^^)</p>



<pre class="wp-block-code language-TypeScript"><code>export default defineNuxtConfig({
  // ...config
  nitro: {
    preset: 'aws-lambda',
    serveStatic: false,
  }
})</code></pre>



<p>また、静的ファイルの配信を確認するため、画像を1枚追加しておきます。<code>public</code> ディレクトリに画像を追加し、画像を表示するページも作成します。</p>



<p>※Nuxt2での <code>static</code> は、Nuxt3になって <code>public</code> に変わっています。</p>



<div class="wp-block-image"><figure class="aligncenter size-full is-resized"><img decoding="async" loading="lazy" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.36.07.png" alt="" class="wp-image-518" width="451" height="320" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.36.07.png 575w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.36.07-300x213.png 300w" sizes="(max-width: 451px) 100vw, 451px" /></figure></div>



<p>ここまで準備ができたら、ビルドをしてデプロイするアセットを作成します。</p>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img decoding="async" loading="lazy" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.50.53-1024x395.png" alt="" class="wp-image-526" width="662" height="255" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.50.53-1024x395.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.50.53-300x116.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.50.53-768x297.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.50.53-1536x593.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.50.53.png 1590w" sizes="(max-width: 662px) 100vw, 662px" /></figure></div>



<p>問題なく完了すれば、<code>.output</code> ディレクトリにデプロイする対象のファイルが生成されていることを確認できます。</p>



<div class="wp-block-image"><figure class="aligncenter size-full is-resized"><img decoding="async" loading="lazy" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.49.22.png" alt="" class="wp-image-527" width="597" height="359" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.49.22.png 1005w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.49.22-300x181.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.49.22-768x462.png 768w" sizes="(max-width: 597px) 100vw, 597px" /></figure></div>



<h2 class="wp-block-heading">デプロイの設定</h2>



<p>Serverless Framework を利用してLambdaへデプロイを行います。 以下のコマンドでパッケージを追加します。</p>



<pre class="wp-block-code language-shellsession"><code>yarn add -D serverless</code></pre>



<p><code>serverless.yml</code> ファイルを作成し、以下の設定を書いておきます。</p>



<pre class="wp-block-code language-yaml"><code>service: sample-lambda-ssr-nuxt3
frameworkVersion: '3'
provider:
  name: aws
  stage: dev
  region: ap-northeast-1

package:
  patterns:
    - '!**'
    - '.output/server/**'

functions:
  NuxtSsrCore:
    runtime: nodejs16.x
    handler: '.output/server/index.handler'
    url: true</code></pre>



<p>以下のコマンドで Lambda をデプロイします。</p>



<pre class="wp-block-code language-shellsession"><code>yarn sls deploy</code></pre>



<p>続いて、画像を配置するS3バケットと、CloudFront Distributionを作成します。振り分けの設定については、CloudFrontのBehaviorを以下のように設定します。</p>



<figure class="wp-block-image size-large"><img decoding="async" loading="lazy" width="1024" height="304" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.42.56-1024x304.png" alt="" class="wp-image-519" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.42.56-1024x304.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.42.56-300x89.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.42.56-768x228.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.42.56.png 1109w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>S3バケットにはビルド済みアセット<code>.output</code>の中から、<code>public</code> 以下のファイルをアップロードしておきます。</p>



<figure class="wp-block-image size-large"><img decoding="async" loading="lazy" width="1024" height="616" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.46.52-1024x616.png" alt="" class="wp-image-520" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.46.52-1024x616.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.46.52-300x180.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.46.52-768x462.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.46.52.png 1244w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>以下のようなAWS CLI コマンドをnpm scripts に登録しておくと簡単にアップロード作業の自動化を行うことができます。</p>



<pre class="wp-block-code language-shellsession"><code>aws s3 sync .output/public s3://{静的ファイルのオリジンS3バケット名}</code></pre>



<h2 class="wp-block-heading">動作確認</h2>



<p>CloudFrontのURLを開き、実際にアプリケーションが動作する様子と指定した静的ファイル（写真）の取得が反映されているか確認します。</p>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img decoding="async" loading="lazy" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.03.31-1-1024x660.png" alt="" class="wp-image-523" width="581" height="374" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.03.31-1-1024x660.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.03.31-1-300x193.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.03.31-1-768x495.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.03.31-1.png 1153w" sizes="(max-width: 581px) 100vw, 581px" /></figure></div>



<p>ブラウザの Developer Tool から Network タブを開き、意図した通りに必要なアセットが読み込まれていることを確認します。</p>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img decoding="async" loading="lazy" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.59.39-1024x515.png" alt="" class="wp-image-524" width="749" height="376" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.59.39-1024x515.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.59.39-300x151.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.59.39-768x387.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-20.59.39.png 1506w" sizes="(max-width: 749px) 100vw, 749px" /></figure></div>



<p>URLを開いた後、Lambda コンソールのモニタリングタブから、呼び出し回数等を確認することができます。</p>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img decoding="async" loading="lazy" src="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.01.56-1024x441.png" alt="" class="wp-image-525" width="758" height="325" srcset="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.01.56-1024x441.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2022/12/Screen-Shot-2022-12-14-at-21.01.56-300x129.png 300w" sizes="(max-width: 758px) 100vw, 758px" /></figure></div>



<p>東京リージョンの場合、Lambdaのメモリサイズとコールドスタート時のレイテンシーは256MBで2〜3s、512MBで1〜2s程度、1GBで1s未満となりほぼ影響を受けなくなります。ただし256MBでも2回目以降の実行では100ms-200msとかなり早くなりますので、アプリケーションの用途や実装にもよりますがLambdaの性能もさほど問題にならない水準であることが言えるかと思います。</p>



<h2 class="wp-block-heading">API Gateway をエンドポイントして利用する場合</h2>



<p>RESTAPI・HTTP API のいずれかでも構築できます。用途に合わせてどちらで作成するかを決めた上で、<code>serverless.yml</code> で該当 Lambda の `events` 属性に以下のように追記します。</p>



<pre class="wp-block-code language-yaml"><code>functions:
  NuxtSsrCore:
    runtime: nodejs16.x
    handler: '.output/server/index.handler'
    url: true
    events:
      - http: # REST API
          method: ANY
          path: /{proxy+}
      - httpApi: # HTTP API
          method: ANY
          path: /{proxy+}</code></pre>



<h2 class="wp-block-heading">まとめ</h2>



<ul><li>Nuxt3 のサーバーエンジン Nitro はビルドターゲットとして AWS Lambda をサポート</li><li>LambdaのデプロイにはServerless Frameworkを利用</li><li>CloudFront, S3との組み合わせて静的ファイルを効率よく配信</li><li>より簡単な構築・１枚設定画面等のユースケースではAPI Gateway+Lambdaの組み合わせも可能</li></ul>



<p>AppRunner/Fargate等コンテナのサービスと比べて迅速なデプロイ・シンプルな構成管理ができ、VPC Lambdaにすればセキュアなデータベースアクセス・アウトバウンドIPの固定が可能になる点等、抽象度の高いサービスでは難しいとされている部分がサーバーレスでありながら解決できるようになります。</p>



<p>AWS Amplify やその他サードパーティのサービスでは乗り越えられない制約がある場合において、対応し得る手段としても捉えてみてはいかがでしょうか。</p>



<p></p>
</div><section class="l-share-button" data-v-629ec8b5 data-v-7de3dd27><aside class="p-share-button" data-v-629ec8b5><div class="p-share-button__header" data-v-629ec8b5>SHARE</div><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fserverless.co.jp%2Fblog%2F512%2F" target="_blank" title="Facebookでシェア" class="p-share-button__link--facebook " data-v-629ec8b5><i class="mdi mdi-facebook" data-v-629ec8b5></i></a><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fserverless.co.jp%2Fblog%2F512%2F&amp;text=AWS%20Lambda%20%2B%20Nuxt3%E3%81%A7%E5%AE%9F%E7%8F%BE%E3%81%99%E3%82%8B%E3%80%8C%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%83%AC%E3%82%B9%E3%81%AASSR%E3%80%8D%E3%81%A8%E3%81%9D%E3%81%AE%E6%A7%8B%E6%88%90" target="_blank" title="Twitterでシェア" class="p-share-button__link--twitter" data-v-629ec8b5><i class="mdi mdi-twitter" data-v-629ec8b5></i></a></aside></section><div class="post-author-container" data-v-7de3dd27><h5 class="post-author-title" data-v-7de3dd27>Written by</h5><div class="post-author-text" data-v-7de3dd27><p data-v-7de3dd27><span class="role" data-v-7de3dd27>
                      COO
                    </span><span class="name-jp" data-v-7de3dd27>
                      金 仙優
                    </span><span class="name-en" data-v-7de3dd27>
                      Sonu Kim
                    </span></p><p class="author-desc" data-v-7de3dd27>
                    
                  </p><ul class="author-sns" data-v-7de3dd27><li data-v-7de3dd27><!----></li><li data-v-7de3dd27><!----></li><li data-v-7de3dd27><!----></li></ul></div></div></div></div></div><div class="p-news-bg" data-v-7de3dd27></div></article><div class="container" data-v-7de3dd27><div class="row justify-center" data-v-7de3dd27><a href="/blog-archives" class="post-archives-link" data-v-7de3dd27><span class="post-archives-link-text" data-v-7de3dd27>BACK TO LIST</span><span data-v-7de3dd27><img src="/assets/img/icon-back-to-list.3add3700.svg" alt="BACK TO LIST アイコン" data-v-7de3dd27></span></a></div></div></div></div></main><footer class="v-footer footer v-sheet v-sheet--tile theme--dark" data-v-a49f4c2c><div class="container" data-v-a49f4c2c data-v-a49f4c2c><div class="row" data-v-a49f4c2c data-v-a49f4c2c><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><a href="/works-archives" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>Works</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>実績紹介</div></a><ul class="c-footer-list" data-v-a49f4c2c><div data-v-b68eaa08 data-v-a49f4c2c><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/501/" class="c-footer-list__link" data-v-b68eaa08>
      戸田建設株式会社
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/396/" class="c-footer-list__link" data-v-b68eaa08>
      北海道テレビ放送株式会社
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/358/" class="c-footer-list__link" data-v-b68eaa08>
      株式会社Geolonia
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/24/" class="c-footer-list__link" data-v-b68eaa08>
      株式会社LIXIL
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/185/" class="c-footer-list__link" data-v-b68eaa08>
      株式会社TOKION
    </a></li></div></ul></div><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><div data-v-a49f4c2c><a href="/services" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>Services</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>サービス紹介</div></a></div><ul class="c-footer-list" data-v-a49f4c2c><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services" class="c-footer-list__link" data-v-a49f4c2c>サーバーレスオペレーションズの<br data-v-a49f4c2c>サービスと強み</a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/iot-serverless" class="c-footer-list__link" data-v-a49f4c2c>
              IoT × サーバーレス / コンテナ開発<br data-v-a49f4c2c>導⼊サポート
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/aws-serverless" class="c-footer-list__link" data-v-a49f4c2c>
              AWSコアサーバーレスサービスの開発導⼊サポート
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/serverless-consulting" class="c-footer-list__link" data-v-a49f4c2c>サーバーレスコンサルティング</a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/serverless-development" class="c-footer-list__link" data-v-a49f4c2c>サーバーレスディべロプメント</a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/our-products" class="c-footer-list__link" data-v-a49f4c2c>
              自社開発プロダクト
            </a></li></ul></div><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><a href="/blog-archives" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>Blog</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>開発ブログ</div></a><ul class="c-footer-list" data-v-a49f4c2c><div data-v-39434060 data-v-a49f4c2c><li class="c-footer-list__item" data-v-39434060><a href="/blog/640/" class="c-footer-list__link" data-v-39434060>
      AWS 開発基盤として、セキュリティを考慮したマルチアカウント構成のススメ
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/532/" class="c-footer-list__link" data-v-39434060>
      AWS Amplify GraphQL Transformer v2 のデータモデリングとリレーションの仕組みを解説する
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/512/" class="c-footer-list__link active--exact active" data-v-39434060>
      AWS Lambda + Nuxt3で実現する「サーバーレスなSSR」とその構成
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/25/" class="c-footer-list__link" data-v-39434060>
      Serverless Frameworkの使い方まとめ
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/450/" class="c-footer-list__link" data-v-39434060>
      軽量で簡単に使えるキャッシュSaaS、MomentoをAWS Lambdaから使ってみる
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/429/" class="c-footer-list__link" data-v-39434060>
      Next.js アプリケーションを AWS Amplify でホスティングする上でのTIPS
    </a></li></div></ul></div><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><a href="/about" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>About</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>会社案内</div></a><ul class="c-footer-list" data-v-a49f4c2c><li class="c-footer-list__item" data-v-a49f4c2c><a href="/about" class="c-footer-list__link" data-v-a49f4c2c>
              会社案内
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/news-archives/" class="c-footer-list__link" data-v-a49f4c2c>
              おしらせ
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/privacy-policy/" class="c-footer-list__link" data-v-a49f4c2c>
              プライバシーポリシー
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/download" class="c-footer-list__link" data-v-a49f4c2c>
              会社資料ダウンロード
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/contact" class="c-footer-list__link" data-v-a49f4c2c>
              お問い合わせ
            </a></li></ul></div></div><div class="row mt-8 mt-md-12" data-v-a49f4c2c data-v-a49f4c2c><div class="col-md-2 col-12" data-v-a49f4c2c data-v-a49f4c2c><div data-v-a49f4c2c><a href="/" class="active" data-v-a49f4c2c><img src="/assets/img/footer-severless-operations-logo.e1e6687a.svg" alt="Severless Operations ロゴ" data-v-a49f4c2c></a></div></div><div class="col-md-10 col-12" data-v-a49f4c2c data-v-a49f4c2c><div class="sns-link text-md-right" data-v-a49f4c2c><a href="https://github.com/serverless-operations" target="_blank" class="sns-link__github" data-v-a49f4c2c><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" data-v-a49f4c2c></i></a><a href="https://twitter.com/slsopsinc" target="_blank" class="sns-link__twitter" data-v-a49f4c2c><i aria-hidden="true" class="v-icon notranslate mdi mdi-twitter theme--light" data-v-a49f4c2c></i></a></div></div><div class="footer-copyright" data-v-a49f4c2c>
        © Serverless Operations, inc
      </div></div></div></footer></div></div>
    <script>window.__INITIAL_STATE__={"data":{"wordPressBlog":{"title":"AWS Lambda + Nuxt3で実現する「サーバーレスなSSR」とその構成","content":"\n\u003Cp\u003Eこの記事は\u003Ca href=\"https:\u002F\u002Fqiita.com\u002Fadvent-calendar\u002F2022\u002Flambda\" data-type=\"URL\" data-id=\"https:\u002F\u002Fqiita.com\u002Fadvent-calendar\u002F2022\u002Flambda\" target=\"_blank\" rel=\"noreferrer noopener\"\u003EAWS LambdaとServerless Advent Calendar 2022\u003C\u002Fa\u003Eの15日目の記事です。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Eフロントエンドの開発トレンドが多様化しています。JSをクライアントのブラウザでのみ実行するCSR（Client-side rendering）及びSPA（Single page application）のような開発構成に続き、近年ではサーバーサイドからJSを利用して動的にHTMLを生成するSSR（Server-side rendering）フレームワークの利用が浸透するようになりました。例えばReactではNext.js、VueではNuxt.jsがあります。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Eアプリケーションの目的や性質によって適切な技術選定を行うことは当然のことですが、様々なニーズに合わせて自由度高くアプリケーションを開発する必要が出てくることも多いのではないでしょうか。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Eこの記事ではAWS環境での「サーバーレスなSSR」として、AWS Lambda を使って Nuxt3 アプリケーションを動かす構成を紹介します。Next.jsに関してはAWS Amplifyを利用する選択肢がありますが、この記事ではAWS Lambdaを直接指定してビルドとデプロイが可能になった最新のNuxt3を使って説明していきます。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003ENuxt2の経験がある方は是非キャッチアップしていただき、Nuxt自体よく分からないという方でも、「コンテナを使わなくても、AWS LambdaでSSRフレームワークが動くのね」という観点で読んでいただけますと幸いです。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Eこの記事を作成している時点（2022\u002F12\u002F14）での最新のNuxt3ではSPA\u002FSSGを想定した静的アセットでのビルドも可能ですが、基本的には Universal Rendering（初回SSR実行、以降CSR）がおすすめです。また、Nuxt3はNitroという新しいエンジンを利用したビルドと実行を行い、ビルドターゲットとしてAWS Lambda がサポートされています。expressに依存せず軽便に扱えるので、エッジコンピューティングの恩恵を受けることも狙いとされています（※\u003Ca rel=\"noreferrer noopener\" href=\"https:\u002F\u002Fnuxt.com\u002Fdocs\u002Fguide\u002Fconcepts\u002Frendering\u002F#rendering-on-cdn-edge-workers\" target=\"_blank\"\u003ERendering on CDN Edge Workers\u003C\u002Fa\u003E）。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E総じてNuxt2のSPAよりも優れた開発経験となることが多いので、是非一度お試しいただければと思います。\u003C\u002Fp\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003E構成の概要\u003C\u002Fh2\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"aligncenter size-full is-resized\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002Fimg_1-1.png\" alt=\"\" class=\"wp-image-514\" width=\"549\" height=\"245\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002Fimg_1-1.png 721w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002Fimg_1-1-300x134.png 300w\" sizes=\"(max-width: 549px) 100vw, 549px\" \u002F\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003E基本的にはCloudFrontのエンドポイントからリクエストを受け、SSRの実行と静的ファイルのパスを振り分ける対応を行います。Lambdaに関しては今年リリースされたFunction URLを設定することで、シンプルな形としてCloudFrontと連携できます。もしLambdaの機能を使いこなす必要がなく、機能が限定される等の制約を気にしなくて良い場合、Lambda@Edgeでレンダリングを行う構成もあります。\u003C\u002Fp\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"aligncenter size-full\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" width=\"521\" height=\"221\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002Fimg_2-1.png\" alt=\"\" class=\"wp-image-516\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002Fimg_2-1.png 521w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002Fimg_2-1-300x127.png 300w\" sizes=\"(max-width: 521px) 100vw, 521px\" \u002F\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003Eまた、API Gateway のエンドポイントを利用するパターンがあります。開発するアプリケーションによっては、CloudFront を置くほどのものでもなかったり、クライアント証明を導入する必要があったり、細かいアクセス制御を行いたいケースがあります。具体的には空ページを１枚挟んでアプリ間連携を行ったり、ちょっとした設定を行う１枚画面などのユースケースもあるかと思います。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003ELambdaから直接静的ファイルのアセットを配信することも可能で、REST API・HTTP API 両方のモードで動作します。Lambda proxy integration で統合することで特別な設定を行わなくてもつながるので、最も構築が簡単な構成になります。\u003C\u002Fp\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003ENuxt3 アプリケーションを準備する\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003Eそれでは、実際に構築を行ってみます。まずはサンプルとなるNuxt3アプリケーションのプロジェクトを生成します。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-shellsession\"\u003E\u003Ccode\u003Enpx nuxi init sample-lambda-ssr-project\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003E\u003Ccode\u003Enuxt.config.ts\u003C\u002Fcode\u003E にビルド設定を追記します。nuxt2 を使われた経験がある方は馴染みのある設定ファイルではないでしょうか。個人的にはここで \u003Ccode\u003Eaws-lambda\u003C\u002Fcode\u003E という設定が書けるだけでもテンションが上りました(^^)\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-TypeScript\"\u003E\u003Ccode\u003Eexport default defineNuxtConfig({\n  \u002F\u002F ...config\n  nitro: {\n    preset: 'aws-lambda',\n    serveStatic: false,\n  }\n})\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003Eまた、静的ファイルの配信を確認するため、画像を1枚追加しておきます。\u003Ccode\u003Epublic\u003C\u002Fcode\u003E ディレクトリに画像を追加し、画像を表示するページも作成します。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E※Nuxt2での \u003Ccode\u003Estatic\u003C\u002Fcode\u003E は、Nuxt3になって \u003Ccode\u003Epublic\u003C\u002Fcode\u003E に変わっています。\u003C\u002Fp\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"aligncenter size-full is-resized\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.36.07.png\" alt=\"\" class=\"wp-image-518\" width=\"451\" height=\"320\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.36.07.png 575w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.36.07-300x213.png 300w\" sizes=\"(max-width: 451px) 100vw, 451px\" \u002F\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003Eここまで準備ができたら、ビルドをしてデプロイするアセットを作成します。\u003C\u002Fp\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"aligncenter size-large is-resized\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.50.53-1024x395.png\" alt=\"\" class=\"wp-image-526\" width=\"662\" height=\"255\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.50.53-1024x395.png 1024w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.50.53-300x116.png 300w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.50.53-768x297.png 768w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.50.53-1536x593.png 1536w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.50.53.png 1590w\" sizes=\"(max-width: 662px) 100vw, 662px\" \u002F\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003E問題なく完了すれば、\u003Ccode\u003E.output\u003C\u002Fcode\u003E ディレクトリにデプロイする対象のファイルが生成されていることを確認できます。\u003C\u002Fp\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"aligncenter size-full is-resized\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.49.22.png\" alt=\"\" class=\"wp-image-527\" width=\"597\" height=\"359\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.49.22.png 1005w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.49.22-300x181.png 300w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.49.22-768x462.png 768w\" sizes=\"(max-width: 597px) 100vw, 597px\" \u002F\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eデプロイの設定\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003EServerless Framework を利用してLambdaへデプロイを行います。 以下のコマンドでパッケージを追加します。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-shellsession\"\u003E\u003Ccode\u003Eyarn add -D serverless\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003E\u003Ccode\u003Eserverless.yml\u003C\u002Fcode\u003E ファイルを作成し、以下の設定を書いておきます。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-yaml\"\u003E\u003Ccode\u003Eservice: sample-lambda-ssr-nuxt3\nframeworkVersion: '3'\nprovider:\n  name: aws\n  stage: dev\n  region: ap-northeast-1\n\npackage:\n  patterns:\n    - '!**'\n    - '.output\u002Fserver\u002F**'\n\nfunctions:\n  NuxtSsrCore:\n    runtime: nodejs16.x\n    handler: '.output\u002Fserver\u002Findex.handler'\n    url: true\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003E以下のコマンドで Lambda をデプロイします。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-shellsession\"\u003E\u003Ccode\u003Eyarn sls deploy\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003E続いて、画像を配置するS3バケットと、CloudFront Distributionを作成します。振り分けの設定については、CloudFrontのBehaviorを以下のように設定します。\u003C\u002Fp\u003E\n\n\n\n\u003Cfigure class=\"wp-block-image size-large\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"304\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.42.56-1024x304.png\" alt=\"\" class=\"wp-image-519\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.42.56-1024x304.png 1024w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.42.56-300x89.png 300w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.42.56-768x228.png 768w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.42.56.png 1109w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \u002F\u003E\u003C\u002Ffigure\u003E\n\n\n\n\u003Cp\u003ES3バケットにはビルド済みアセット\u003Ccode\u003E.output\u003C\u002Fcode\u003Eの中から、\u003Ccode\u003Epublic\u003C\u002Fcode\u003E 以下のファイルをアップロードしておきます。\u003C\u002Fp\u003E\n\n\n\n\u003Cfigure class=\"wp-block-image size-large\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"616\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.46.52-1024x616.png\" alt=\"\" class=\"wp-image-520\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.46.52-1024x616.png 1024w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.46.52-300x180.png 300w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.46.52-768x462.png 768w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.46.52.png 1244w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \u002F\u003E\u003C\u002Ffigure\u003E\n\n\n\n\u003Cp\u003E以下のようなAWS CLI コマンドをnpm scripts に登録しておくと簡単にアップロード作業の自動化を行うことができます。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-shellsession\"\u003E\u003Ccode\u003Eaws s3 sync .output\u002Fpublic s3:\u002F\u002F{静的ファイルのオリジンS3バケット名}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003E動作確認\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003ECloudFrontのURLを開き、実際にアプリケーションが動作する様子と指定した静的ファイル（写真）の取得が反映されているか確認します。\u003C\u002Fp\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"aligncenter size-large is-resized\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.03.31-1-1024x660.png\" alt=\"\" class=\"wp-image-523\" width=\"581\" height=\"374\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.03.31-1-1024x660.png 1024w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.03.31-1-300x193.png 300w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.03.31-1-768x495.png 768w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.03.31-1.png 1153w\" sizes=\"(max-width: 581px) 100vw, 581px\" \u002F\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003Eブラウザの Developer Tool から Network タブを開き、意図した通りに必要なアセットが読み込まれていることを確認します。\u003C\u002Fp\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"aligncenter size-large is-resized\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.59.39-1024x515.png\" alt=\"\" class=\"wp-image-524\" width=\"749\" height=\"376\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.59.39-1024x515.png 1024w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.59.39-300x151.png 300w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.59.39-768x387.png 768w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-20.59.39.png 1506w\" sizes=\"(max-width: 749px) 100vw, 749px\" \u002F\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003EURLを開いた後、Lambda コンソールのモニタリングタブから、呼び出し回数等を確認することができます。\u003C\u002Fp\u003E\n\n\n\n\u003Cdiv class=\"wp-block-image\"\u003E\u003Cfigure class=\"aligncenter size-large is-resized\"\u003E\u003Cimg decoding=\"async\" loading=\"lazy\" src=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.01.56-1024x441.png\" alt=\"\" class=\"wp-image-525\" width=\"758\" height=\"325\" srcset=\"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.01.56-1024x441.png 1024w, https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2022\u002F12\u002FScreen-Shot-2022-12-14-at-21.01.56-300x129.png 300w\" sizes=\"(max-width: 758px) 100vw, 758px\" \u002F\u003E\u003C\u002Ffigure\u003E\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003E東京リージョンの場合、Lambdaのメモリサイズとコールドスタート時のレイテンシーは256MBで2〜3s、512MBで1〜2s程度、1GBで1s未満となりほぼ影響を受けなくなります。ただし256MBでも2回目以降の実行では100ms-200msとかなり早くなりますので、アプリケーションの用途や実装にもよりますがLambdaの性能もさほど問題にならない水準であることが言えるかと思います。\u003C\u002Fp\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003EAPI Gateway をエンドポイントして利用する場合\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003ERESTAPI・HTTP API のいずれかでも構築できます。用途に合わせてどちらで作成するかを決めた上で、\u003Ccode\u003Eserverless.yml\u003C\u002Fcode\u003E で該当 Lambda の `events` 属性に以下のように追記します。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-yaml\"\u003E\u003Ccode\u003Efunctions:\n  NuxtSsrCore:\n    runtime: nodejs16.x\n    handler: '.output\u002Fserver\u002Findex.handler'\n    url: true\n    events:\n      - http: # REST API\n          method: ANY\n          path: \u002F{proxy+}\n      - httpApi: # HTTP API\n          method: ANY\n          path: \u002F{proxy+}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eまとめ\u003C\u002Fh2\u003E\n\n\n\n\u003Cul\u003E\u003Cli\u003ENuxt3 のサーバーエンジン Nitro はビルドターゲットとして AWS Lambda をサポート\u003C\u002Fli\u003E\u003Cli\u003ELambdaのデプロイにはServerless Frameworkを利用\u003C\u002Fli\u003E\u003Cli\u003ECloudFront, S3との組み合わせて静的ファイルを効率よく配信\u003C\u002Fli\u003E\u003Cli\u003Eより簡単な構築・１枚設定画面等のユースケースではAPI Gateway+Lambdaの組み合わせも可能\u003C\u002Fli\u003E\u003C\u002Ful\u003E\n\n\n\n\u003Cp\u003EAppRunner\u002FFargate等コンテナのサービスと比べて迅速なデプロイ・シンプルな構成管理ができ、VPC Lambdaにすればセキュアなデータベースアクセス・アウトバウンドIPの固定が可能になる点等、抽象度の高いサービスでは難しいとされている部分がサーバーレスでありながら解決できるようになります。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003EAWS Amplify やその他サードパーティのサービスでは乗り越えられない制約がある場合において、対応し得る手段としても捉えてみてはいかがでしょうか。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E\u003C\u002Fp\u003E\n","author":{"name":"Sonu Kim","description":"","avatars":{"avatar96":"https:\u002F\u002Fsecure.gravatar.com\u002Favatar\u002F5b527696e38c84c34048954d767b1537?s=96&d=mm&r=g"},"acf":{"userJpName":"金 仙優","userRole":"COO","facebook":"","twitter":"","github":""}},"date":"2022.12.14","path":"\u002Fblog\u002F512\u002F","featuredMedia":{"sourceUrl":"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2020\u002F05\u002Fso-release.png","altText":"so-release-image","mediaDetails":{"width":1200}},"categories":[{"id":"7","title":"Blog","path":"\u002Fcategory\u002Fblog\u002F"}],"tags":[{"id":"71","title":"AWS Lambda","path":"\u002Ftag\u002Faws-lambda\u002F"},{"id":"72","title":"Nuxt3","path":"\u002Ftag\u002Fnuxt3\u002F"},{"id":"60","title":"Server-side rendering","path":"\u002Ftag\u002Fserver-side-rendering\u002F"},{"id":"2","title":"Serverless","path":"\u002Ftag\u002Fserverless\u002F"},{"id":"58","title":"SSR","path":"\u002Ftag\u002Fssr\u002F"},{"id":"21","title":"Vue","path":"\u002Ftag\u002Fvue\u002F"}]},"metadata":{"siteName":"Serverless Operations","siteDescription":"Serverless Operationsは、これまでグローバルの第一線で培ってきたクラウド技術（AWS − アマゾンウェブサービス）の豊富な実績と知見を活かし、お客さまのサーバーレスによる開発や運用の支援、コンサルティングまで一貫してサポート。サーバーレスに関するさまざまな課題を解決いたします。","siteUrl":"https:\u002F\u002Fserverless.co.jp","siteOgImage":"https:\u002F\u002Fserverless.co.jp\u002Fogp.png"}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.748a8736.js" defer></script><script src="/assets/js/page--src--templates--word-press-blog-vue.3139ba43.js" defer></script><script data-vue-tag="ssr" src="https://webfont.fontplus.jp/accessor/script/fontplus.js?LuMx0zy9taw%3D&box=ME4Rs88c3-0%3D&aa=1&ab=2" data-body="true"></script>
  </body>
</html>
