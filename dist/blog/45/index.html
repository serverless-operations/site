<!DOCTYPE html>
<html data-html-server-rendered="true" lang="ja" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22ja%22%7D%7D">
  <head>
    <title>AWS Lambdaのユニットテストのベストプラクティス(Node.js) | Serverless Operations</title><meta name="gridsome:hash" content="d3dc5a74472b579ca6ae7ca671dc4f013853a504"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.14"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="og:locale" property="og:locale" content="ja_JP"><meta data-vue-tag="ssr" data-key="og:site_name" property="og:site_name" content="Serverless Operations"><meta data-vue-tag="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" name="twitter:image" content="https://serverless.co.jp/ogp.png"><meta data-vue-tag="ssr" data-key="og:type" property="og:type" content="article"><meta data-vue-tag="ssr" data-key="og:url" property="og:url" content="https://serverless.co.jp/blog/45/"><meta data-vue-tag="ssr" data-key="og:image" property="og:image" content="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2017/06/AWS-Lambda_dark-bg@4x.png"><meta data-vue-tag="ssr" data-key="og:title" property="og:title" content="AWS Lambdaのユニットテストのベストプラクティス(Node.js) | Serverless Operations"><meta data-vue-tag="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" name="twitter:image" content="https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2017/06/AWS-Lambda_dark-bg@4x.png"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.2cc8acaa6971d9266cbf9d7d5455c37a.png"><link data-vue-tag="ssr" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css"><link data-vue-tag="ssr" data-key="canonical" rel="canonical" href="https://serverless.co.jp/blog/45/"><link rel="preload" href="/assets/css/0.styles.adfe40b8.css" as="style"><link rel="preload" href="/assets/js/app.a1e03411.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--word-press-blog-vue.fdf3ed1a.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules--gridsome--app--pages--404-vue.84e8aa18.js"><link rel="prefetch" href="/assets/js/page--src--pages--about-vue.094252a3.js"><link rel="prefetch" href="/assets/js/page--src--pages--blog-archives-vue.771d12fd.js"><link rel="prefetch" href="/assets/js/page--src--pages--contact-vue.c49312ad.js"><link rel="prefetch" href="/assets/js/page--src--pages--download-vue.e2fb64ed.js"><link rel="prefetch" href="/assets/js/page--src--pages--event-archives-vue.dc6c64cc.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.7cd9b288.js"><link rel="prefetch" href="/assets/js/page--src--pages--news-archives-vue.2871bf8d.js"><link rel="prefetch" href="/assets/js/page--src--pages--our-products-vue.d569f152.js"><link rel="prefetch" href="/assets/js/page--src--pages--privacy-policy-vue.9015b9cf.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--aws-serverless-vue.548b9c96.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--aws-serverless-vue~page--src--pages--services--iot-serverless-vue.bada637e.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--index-vue.605da173.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--iot-serverless-vue.1324af58.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--serverless-consulting-vue.bf933f33.js"><link rel="prefetch" href="/assets/js/page--src--pages--services--serverless-development-vue.d8c60529.js"><link rel="prefetch" href="/assets/js/page--src--pages--test-form-vue.37425afa.js"><link rel="prefetch" href="/assets/js/page--src--pages--works-archives-vue.b641ea0a.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-category-vue.7424850d.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-post-tag-vue.a058c92f.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-post-vue.8fb7ceee.js"><link rel="prefetch" href="/assets/js/page--src--templates--word-press-works-vue.dc66c364.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--contact-vue~page--src--pages--download-vue.7a23cb3f.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--our-products-vue.8e9052c2.js"><link rel="prefetch" href="/assets/js/vendors~page--src--templates--word-press-blog-vue.16b09ab1.js"><link rel="stylesheet" href="/assets/css/0.styles.adfe40b8.css"><script data-vue-tag="ssr">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-MLP4448');</script><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div id="app" data-server-rendered="true" class="v-application v-application--is-ltr theme--dark" data-v-7de3dd27><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MLP4448" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="v-application--wrap"><header class="header-nav" data-v-5f4f5539><div class="header-nav__logo-block" data-v-5f4f5539><a href="/" class="header-nav__logo-link active" data-v-5f4f5539><img src="/assets/img/header-logo.a93f880b.svg" alt="Severless Operations ロゴ" class="header-nav__logo" data-v-5f4f5539></a></div><nav data-v-5f4f5539><ul data-v-5f4f5539><li data-v-5f4f5539><a href="/about" data-v-5f4f5539>私たちについて</a></li><li data-v-5f4f5539><a href="/services" data-v-5f4f5539>サービス</a></li><li data-v-5f4f5539><a href="/works-archives" data-v-5f4f5539>実績紹介</a></li><li data-v-5f4f5539><a href="/blog-archives" data-v-5f4f5539>ブログ</a></li><li data-v-5f4f5539><a href="/news-archives" data-v-5f4f5539>お知らせ</a></li><li data-v-5f4f5539><a href="/download" data-v-5f4f5539>会社資料ダウンロード</a></li><li data-v-5f4f5539><a href="/contact" data-v-5f4f5539>お問い合わせ</a></li></ul></nav><div id="app" class="header-nav__toggler-block d-block d-md-none" data-v-5f4f5539><button id="btn" type="button" class="header-nav__toggler-button btn" data-v-5f4f5539><div tabindex="-1" class="btn__content" data-v-5f4f5539><span class="header-nav__toggler-top" data-v-5f4f5539></span><span class="header-nav__toggler-middle" data-v-5f4f5539></span><span class="header-nav__toggler-bottom" data-v-5f4f5539></span></div></button></div><!----></header><main class="v-content"><div class="v-content" data-v-7de3dd27><div class="v-content__wrap" data-v-7de3dd27><div class="container" data-v-7de3dd27><p class="category-title" data-v-7de3dd27>
          Blog
        </p></div><header class="post-header" data-v-7de3dd27><div class="container" data-v-7de3dd27><div class="row justify-center" data-v-7de3dd27><div class="col-md-10 col-11" data-v-7de3dd27><h1 class="post-title" data-v-7de3dd27>AWS Lambdaのユニットテストのベストプラクティス(Node.js)</h1><div class="post-tag-container" data-v-7de3dd27><time datetime="2017.06.30" class="post-date" data-v-7de3dd27> 
                  2017.06.30
                  
                </time><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>Lambda</span></div><div class="post-tags" data-v-7de3dd27><span data-v-7de3dd27>ユニットテスト</span></div></div></div></div></div></header><article class="post-container" data-v-7de3dd27><div class="container" data-v-7de3dd27><div class="row justify-center" data-v-7de3dd27><div class="post-article-container col-md-10 col-11" data-v-7de3dd27><div class="post-article" data-v-7de3dd27>
<h2 class="wp-block-heading">概要</h2>



<p>みなさん、テスト書いてますかーー！<br>AWS Lambdaはサーバーレスアーキテクチャを構成する上で、重要なサービスです。そして、その特性上、ユニットテストを書いて変更に強いコードにすることが、継続的なメンテナンスや改善を行っていく上で非常に重要なものとなります。</p>



<p>この記事は、まずローカルで行うLambdaのユニットテストについてその具体的な手法を書いています。なお、ベストプラクティスってタイトルにしてますが、これはベストプラクティスのひとつであり、その要件ややりたいことや個人的な趣味趣向によって変わってくるということは理解してるので、ひとつのやり方としてみなさんの参考になればと思っています。</p>



<h2 class="wp-block-heading">テスト対象のLambdaとその要件</h2>



<p>では、まず初めにテスト対象となるLambdaファンクションの要件を以下のように定義してみます。これを元にしてテストを書きつつその流れを解説したいと思います。</p>



<h3 class="wp-block-heading">要件</h3>



<p>まずは今回の要件です。DynamoDBに以下のBlogテーブルが存在していたとしましょう。</p>



<figure class="wp-block-table"><table><thead><tr><th>key</th><th>用途</th></tr></thead><tbody><tr><td>post_id</td><td>記事ID(ハッシュキー)</td></tr><tr><td>post_title</td><td>タイトル</td></tr><tr><td>post_content</td><td>本文</td></tr></tbody></table></figure>



<p>以下のような実装を行いたいと考えてみます。<br>&#8211; post_idがLambdaへの外部からの入力値となる<br>&#8211; post_idを元にBlogテーブルを検索して、該当のpost_titleとpost_contentを取得する<br>&#8211; post_titleとpost_contentを返す</p>



<h4 class="wp-block-heading">処理の流れ</h4>



<p>この処理の流れをフローチャートにすると以下のようになります。<br><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F65478%2F86b4d71d-1583-0e01-b2c9-0cd85406d9ca.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=17a2fb0da65b95868261df8e2a3c29cd" target="_blank" rel="noreferrer noopener"></a></p>



<h3 class="wp-block-heading">テストのパターン</h3>



<p>まずは、どういったテストを網羅する必要があるのかを考えてみます。上記のフローチャートを見ながら、正常系と異常系に分けて考えてみましょう。</p>



<p>以下のようなパターンが考えられると思います。</p>



<h4 class="wp-block-heading">正常系</h4>



<ul><li>post_idが渡され、Blogテーブルから検索したデータを返した</li></ul>



<h4 class="wp-block-heading">異常系</h4>



<ul><li>Lambdaにpost_idが渡されなかった</li><li>post_idはLambdaに渡されたが、Blogテーブルに該当のデータが無かった</li><li>DynamoDB自体が落ちていて処理されなかった</li></ul>



<p>では、これからこの4パターンでテストコードを作っていきましょう。</p>



<h2 class="wp-block-heading">使用するユニットテスト用のライブラリ</h2>



<p>まずはテストコードを書く前にユニットテストに使用したライブラリを紹介します。<br>Node.jsでテストを書く場合は良く出てくるライブラリですので覚えていて損は無いでしょう。</p>



<h3 class="wp-block-heading">chai</h3>



<p><a href="http://chaijs.com/" rel="noreferrer noopener" target="_blank">http://chaijs.com/</a>&nbsp;はJavaScript用のアサーションライブラリです。これを使うことで、期待通りの入力値と出力値になっているか比較して、テストの成否を判定します。</p>



<h3 class="wp-block-heading">Chai as Promised</h3>



<p><a href="https://github.com/domenic/chai-as-promised" rel="noreferrer noopener" target="_blank">https://github.com/domenic/chai-as-promised</a>&nbsp;はchaiのPromise用の拡張です。<br>Promiseの状態がどうなっているかを判定します。</p>



<h3 class="wp-block-heading">Mocha</h3>



<p><a href="https://mochajs.org/" rel="noreferrer noopener" target="_blank">https://mochajs.org/</a>&nbsp;はテスティングフレームワークライブラリです。テストを書くための枠組みを提供してくれたり、コマンドラインからの実行をサポートしてくれたり、<code>beforeEach()</code>や<code>after()</code>といったテスト前後の定形処理を行う関数を提供してくれたりします。テストを実行するための環境を整えてくれるライブラリです。</p>



<h3 class="wp-block-heading">proxyquire</h3>



<p><a href="https://github.com/thlorenz/proxyquire" rel="noreferrer noopener" target="_blank">https://github.com/thlorenz/proxyquire</a>&nbsp;はrequireモジュールをスタブ化して動作を変更します。要はローカルでテストするにあたって、aws-sdkが毎回AWSに接続されてしまってはテストが出来ません。そこでproxyquireを使うことでaws-sdkの処理を書き換え、ローカルでテストが行えるようにします。</p>



<h3 class="wp-block-heading">sinon</h3>



<p><a href="http://sinonjs.org/" rel="noreferrer noopener" target="_blank">http://sinonjs.org/</a>&nbsp;はテスト用にスタブやモック、スパイを作ってくれるライブラリです。今回はスパイの用途で使用して、proxyquireでスタブ化されたaws-sdkが仕様にそって呼び出されているかをチェックします。</p>



<h3 class="wp-block-heading">Istanbul</h3>



<p><a href="https://istanbul.js.org/" rel="noreferrer noopener" target="_blank">https://istanbul.js.org/</a>&nbsp;はコードのカバレッジ計測をしてくれるライブラリです。例えばif文がひとつ追加されると、単純にテストケースとしては2つのケースに分岐されます。そういった形でソースコードの静的解析を行うことでどの程度全体のテストが網羅されているのかを計測します</p>



<h2 class="wp-block-heading">メインのソースコード</h2>



<p>まずは先にLambdaファンクションのソースコードを載せておきます。上記のフローチャートをそのままLambdaに落とし込むと以下のようになります。</p>



<pre class="wp-block-code language-js"><code>'use strict'
const aws = require('aws-sdk')
const dynamodb = new aws.DynamoDB.DocumentClient()

module.exports.blog = (event, context, callback) => {
  return Promise.resolve().then(() => {
    if (!event.post_id) {
      return Promise.reject(responseBilder(400, {message: 'invalid param'}))
    }

    const params = {
      TableName: 'Blog',
      Key: {
        post_id: event.post_id
      }
    }
    return dynamodb.get(params).promise()
  }).then(data => {
    if (!Object.keys(data).length) {
      return Promise.reject(responseBilder(404, {message: 'can not find specified post'}))
    } else {
      return Promise.resolve(responseBilder(200, {
        post_title: data.Item.post_title,
        post_content: data.Item.post_content
      }))
    }
  })
  .then(result => callback(null, result))
  .catch(error => callback(error))
}

const responseBilder = (statusCode, data) => {
  return JSON.stringify({
    statusCode: statusCode,
    body: data
  })
}</code></pre>



<div class="gridsome-highlight">



<pre class="wp-block-code language-js"><code>const responseBilder = (statusCode, data) => {
  return JSON.stringify({
    statusCode: statusCode,
    body: data
  })
}</code></pre>



</div>



<h2 class="wp-block-heading">ローカルで動作させるためのスタブの構築</h2>



<p>Lambda内ではaws-sdkを使ってAWSリソースにアクセスすることが多くなるかと思います。ローカルでテストを行う場合に毎回AWSリソースにアクセスさせる必要はないため(aws-sdk自体の動作は、このアプリケーションのテストの範疇外)、スタブ化してダミーの値を返しつつ、どういう値で呼ばれたか、テスト内で監視を行うのが良いでしょう。</p>



<h3 class="wp-block-heading">sinonとproxyquireでaws-sdkをスタブ化する</h3>



<p>スタブ化するにはproxyquireにてrequireで呼び出されるaws-sdkモジュールをスタブ化した上で、sinonのstubやspyと言ったメソッドで、スタブの呼び出しを監視しながらテストするのがベターです。</p>



<pre class="wp-block-code language-js"><code>const sinon = require('sinon')
const proxyquire = require('proxyquire')

const proxyDynamoDB = class {
  get (params) {
    return {
      promise: () => {}
    }
  }
}
const lambda = proxyquire('./handler', {
  'aws-sdk': {
    DynamoDB: {
      DocumentClient: proxyDynamoDB
    }
  }
})

const dynamoDbGetStub = sinon.stub(proxyDynamoDB.prototype, 'get')
.returns({promise: () => {
  return Promise.resolve({
    Item: {
      post_title: 'aa',
      post_content: 'bb'
    }
  })
}})</code></pre>



<p>だいたい予想はつくかと思いますが、上記の用に書くと、<code>dynamodb.get</code>はスタブの返り値として指定したJSONを返却してくれます。</p>



<pre class="wp-block-code language-json"><code>{
  "Item": {
    "post_title": "aa",
    "post_content": "bb"
  }
}</code></pre>



<h3 class="wp-block-heading">疑似Lambdaを実行させるための設定</h3>



<p>テストを実行するために擬似的にローカルでLambdaを実行させる仕組みを用意します。<br>以下がLambdaファンクションのメイン部分なので、これを動かせるようにダミーの引数を与えれば良いということになります。</p>



<pre class="wp-block-code language-js"><code>module.exports.blog = (event, context, callback) => {
}</code></pre>



<p>以下の用に引数を定義しましょう。<code>context</code>は今回使用してないので、<code>{}</code>を指定しています。使用している場合は以下のドキュメントを参考にダミーの値を設定しましょう。<br><a href="http://docs.aws.amazon.com/ja_jp/lambda/latest/dg/nodejs-prog-model-context.html" rel="noreferrer noopener" target="_blank">http://docs.aws.amazon.com/ja_jp/lambda/latest/dg/nodejs-prog-model-context.html</a></p>



<p>また、<code>callback</code>にはPromiseを返すようにしていますが、これはテストの結果をPromiseで返えるようにして、値の検査をやりやすくしているためです。</p>



<pre class="wp-block-code language-js"><code>const event = {
  post_id: 'your-post-id'
}
const callback = (error, result) => {
  return new Promise((resolve, reject) => {
    error ? reject(error) : resolve(result)
  })
}
const context = {}</code></pre>



<h2 class="wp-block-heading">テストの実装</h2>



<p>では、それぞれのテストを実装していきましょう。<br>テストのパターンは上記の4つです。それぞれのパターンに分けて解説していきます。</p>



<h3 class="wp-block-heading">post_idが渡され、Blogテーブルから検索したデータを返した</h3>



<p>Promiseの状態が<code>fulfilled</code>になっていること、DynamoDBのgetが1回実行されたこと、正常系の返り値が返ってきたことをテストしています。</p>



<pre class="wp-block-code language-js"><code>it('Should return resolve when running successfully', () => {
  return expect(lambda.blog(event, context, callback)).to.be.fulfilled.then(result => {
    expect(dynamoDbGetStub.calledOnce).to.be.equal(true)
    expect(result).to.deep.equal(JSON.stringify({
      statusCode: 200,
      body: {post_title: 'aa', post_content: 'bb'}
    }))
  })
})</code></pre>



<h3 class="wp-block-heading">Lambdaにpost_idが渡されなかった</h3>



<p>先ほど、post_idをセットしていた<code>event</code>を空オブジェクトで上書きします。<br>そしてPromiseの結果がrejectedになっていること、入力チェックで落ちたためにDynamoDBが呼ばれなかったこと、異常系の返り値が返ってきたことをテストしています。</p>



<pre class="wp-block-code language-js"><code>it('Should return reject when post_id is not given', () => {
  event = {}
  return expect(lambda.blog(event, context, callback)).to.be.rejected.then(result => {
    expect(dynamoDbGetStub.calledOnce).to.be.equal(false)
    expect(result).to.deep.equal(JSON.stringify({
      statusCode: 400,
      body: {message: 'invalid param'}
    }))
  })
})
﻿</code></pre>



<h3 class="wp-block-heading">post_idはLambdaに渡されたが、Blogテーブルに該当のデータが無かった</h3>



<p>dynamoDbGetStubの返り値にデータが取得できなかった時の<code>{}</code>が変えるようにスタブを設定します。そして、異常系の返り値が返ってきたことをテストしています。</p>



<pre class="wp-block-code language-js"><code>it('Should return reject when you can not your item in DB', () => {
  dynamoDbGetStub = sinon.stub(proxyDynamoDB.prototype, 'get')
  .returns({promise: () => {
    return Promise.resolve({})
  }})
  return expect(lambda.blog(event, context, callback)).to.be.rejected.then(result => {
    expect(dynamoDbGetStub.calledOnce).to.be.equal(true)
    expect(result).to.deep.equal(JSON.stringify({
      statusCode: 404,
      body: {message: 'can not find specified post'}
    }))
  })
})</code></pre>



<h3 class="wp-block-heading">DynamoDB自体が落ちていて処理されなかった</h3>



<p>dynamoDbGetStubがrejectedされるようにスタブを設定します。</p>



<pre class="wp-block-code language-js"><code>it('Should return reject when error occurs in DB', () => {
  dynamoDbGetStub = sinon.stub(proxyDynamoDB.prototype, 'get')
  .returns({promise: () => {
    return Promise.reject('error')
  }})
  return expect(lambda.blog(event, context, callback)).to.be.rejected.then(result => {
    expect(dynamoDbGetStub.calledOnce).to.be.equal(true)
    expect(result).to.be.equal('error')
  })
})</code></pre>



<h2 class="wp-block-heading">テストの実行</h2>



<p>package.jsonにて以下のような設定を行いカバレッジの計測とテストの実行を<code>npm run test</code>で行えるようにします。</p>



<pre class="wp-block-code language-json"><code>"scripts": {
  "test": "istanbul cover -x 'handler.test.js' node_modules/mocha/bin/_mocha 'handler.test.js' -- -R spec --recursive"
}</code></pre>



<p>実行結果は以下のとおりです。<br>4つともテストは成功して、カバレッジも100%問題なくテストできていることがわかります。<br><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F65478%2Fafc1fd38-5370-c43c-2cab-fc4abfb530f5.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a7e9738d7a7ca342ecd204272eba7031" target="_blank" rel="noreferrer noopener"></a></p>



<h2 class="wp-block-heading">まとめ</h2>



<p>今回解説したものは以下のGitHubにあげておりますので、興味のある方は確認してみてください<br><a href="https://github.com/horike37/lambda-unittest-sample" rel="noreferrer noopener" target="_blank">https://github.com/horike37/lambda-unittest-sample</a></p>



<p>如何でしたでしょうか。ぜひこれを参考にTest Driven Deveropment for Lambdaを実践していってもらえればと思います！</p>
</div><section class="l-share-button" data-v-629ec8b5 data-v-7de3dd27><aside class="p-share-button" data-v-629ec8b5><div class="p-share-button__header" data-v-629ec8b5>SHARE</div><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fserverless.co.jp%2Fblog%2F45%2F" target="_blank" title="Facebookでシェア" class="p-share-button__link--facebook " data-v-629ec8b5><i class="mdi mdi-facebook" data-v-629ec8b5></i></a><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fserverless.co.jp%2Fblog%2F45%2F&amp;text=AWS%20Lambda%E3%81%AE%E3%83%A6%E3%83%8B%E3%83%83%E3%83%88%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E3%83%99%E3%82%B9%E3%83%88%E3%83%97%E3%83%A9%E3%82%AF%E3%83%86%E3%82%A3%E3%82%B9(Node.js)" target="_blank" title="Twitterでシェア" class="p-share-button__link--twitter" data-v-629ec8b5><i class="mdi mdi-twitter" data-v-629ec8b5></i></a></aside></section><div class="post-author-container" data-v-7de3dd27><h5 class="post-author-title" data-v-7de3dd27>Written by</h5><div class="post-author-text" data-v-7de3dd27><p data-v-7de3dd27><span class="role" data-v-7de3dd27>
                      CEO
                    </span><span class="name-jp" data-v-7de3dd27>
                      堀家 隆宏
                    </span><span class="name-en" data-v-7de3dd27>
                      Takahiro Horike
                    </span></p><p class="author-desc" data-v-7de3dd27>
                    Co-founder and CEO of Serverless Operations, Inc
                  </p><ul class="author-sns" data-v-7de3dd27><li data-v-7de3dd27><a href="https://github.com/horike37" target="_blank" class="github" data-v-7de3dd27><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" data-v-7de3dd27></i></a></li><li data-v-7de3dd27><a href="https://www.facebook.com/horike.takahiro" target="_blank" class="facebook" data-v-7de3dd27><i aria-hidden="true" class="v-icon notranslate mdi mdi-facebook theme--light" data-v-7de3dd27></i></a></li><li data-v-7de3dd27><a href="https://twitter.com/horike37" target="_blank" class="twitter" data-v-7de3dd27><i aria-hidden="true" class="v-icon notranslate mdi mdi-twitter theme--light" data-v-7de3dd27></i></a></li></ul></div></div></div></div></div><div class="p-news-bg" data-v-7de3dd27></div></article><div class="container" data-v-7de3dd27><div class="row justify-center" data-v-7de3dd27><a href="/blog-archives" class="post-archives-link" data-v-7de3dd27><span class="post-archives-link-text" data-v-7de3dd27>BACK TO LIST</span><span data-v-7de3dd27><img src="/assets/img/icon-back-to-list.3add3700.svg" alt="BACK TO LIST アイコン" data-v-7de3dd27></span></a></div></div></div></div></main><footer class="v-footer footer v-sheet v-sheet--tile theme--dark" data-v-a49f4c2c><div class="container" data-v-a49f4c2c data-v-a49f4c2c><div class="row" data-v-a49f4c2c data-v-a49f4c2c><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><a href="/works-archives" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>Works</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>実績紹介</div></a><ul class="c-footer-list" data-v-a49f4c2c><div data-v-b68eaa08 data-v-a49f4c2c><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/666/" class="c-footer-list__link" data-v-b68eaa08>
      A社（企業名非公開）
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/501/" class="c-footer-list__link" data-v-b68eaa08>
      戸田建設株式会社
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/396/" class="c-footer-list__link" data-v-b68eaa08>
      北海道テレビ放送株式会社
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/358/" class="c-footer-list__link" data-v-b68eaa08>
      株式会社Geolonia
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/24/" class="c-footer-list__link" data-v-b68eaa08>
      株式会社LIXIL
    </a></li><li class="c-footer-list__item" data-v-b68eaa08><a href="/works/185/" class="c-footer-list__link" data-v-b68eaa08>
      株式会社TOKION
    </a></li></div></ul></div><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><div data-v-a49f4c2c><a href="/services" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>Services</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>サービス紹介</div></a></div><ul class="c-footer-list" data-v-a49f4c2c><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services" class="c-footer-list__link" data-v-a49f4c2c>サーバーレスオペレーションズの<br data-v-a49f4c2c>サービスと強み</a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/iot-serverless" class="c-footer-list__link" data-v-a49f4c2c>
              IoT × サーバーレス / コンテナ開発<br data-v-a49f4c2c>導⼊サポート
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/aws-serverless" class="c-footer-list__link" data-v-a49f4c2c>
              AWSコアサーバーレスサービスの開発導⼊サポート
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/serverless-consulting" class="c-footer-list__link" data-v-a49f4c2c>サーバーレスコンサルティング</a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/services/serverless-development" class="c-footer-list__link" data-v-a49f4c2c>サーバーレスディべロプメント</a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/our-products" class="c-footer-list__link" data-v-a49f4c2c>
              自社開発プロダクト
            </a></li></ul></div><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><a href="/blog-archives" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>Blog</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>開発ブログ</div></a><ul class="c-footer-list" data-v-a49f4c2c><div data-v-39434060 data-v-a49f4c2c><li class="c-footer-list__item" data-v-39434060><a href="/blog/640/" class="c-footer-list__link" data-v-39434060>
      AWS 開発基盤として、セキュリティを考慮したマルチアカウント構成のススメ
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/532/" class="c-footer-list__link" data-v-39434060>
      AWS Amplify GraphQL Transformer v2 のデータモデリングとリレーションの仕組みを解説する
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/512/" class="c-footer-list__link" data-v-39434060>
      AWS Lambda + Nuxt3で実現する「サーバーレスなSSR」とその構成
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/25/" class="c-footer-list__link" data-v-39434060>
      Serverless Frameworkの使い方まとめ
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/450/" class="c-footer-list__link" data-v-39434060>
      軽量で簡単に使えるキャッシュSaaS、MomentoをAWS Lambdaから使ってみる
    </a></li><li class="c-footer-list__item" data-v-39434060><a href="/blog/429/" class="c-footer-list__link" data-v-39434060>
      Next.js アプリケーションを AWS Amplify でホスティングする上でのTIPS
    </a></li></div></ul></div><div class="footer-list-anim col-sm-6 col-md-3 col-12" data-v-a49f4c2c data-v-a49f4c2c><a href="/about" class="c-footer-list__link" data-v-a49f4c2c><div class="c-footer-menu__title" data-v-a49f4c2c>About</div><div class="c-footer-menu__subtitle" data-v-a49f4c2c>会社案内</div></a><ul class="c-footer-list" data-v-a49f4c2c><li class="c-footer-list__item" data-v-a49f4c2c><a href="/about" class="c-footer-list__link" data-v-a49f4c2c>
              会社案内
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/news-archives/" class="c-footer-list__link" data-v-a49f4c2c>
              おしらせ
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/privacy-policy/" class="c-footer-list__link" data-v-a49f4c2c>
              プライバシーポリシー
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/download" class="c-footer-list__link" data-v-a49f4c2c>
              会社資料ダウンロード
            </a></li><li class="c-footer-list__item" data-v-a49f4c2c><a href="/contact" class="c-footer-list__link" data-v-a49f4c2c>
              お問い合わせ
            </a></li></ul></div></div><div class="row mt-8 mt-md-12" data-v-a49f4c2c data-v-a49f4c2c><div class="col-md-2 col-12" data-v-a49f4c2c data-v-a49f4c2c><div data-v-a49f4c2c><a href="/" class="active" data-v-a49f4c2c><img src="/assets/img/footer-severless-operations-logo.e1e6687a.svg" alt="Severless Operations ロゴ" data-v-a49f4c2c></a></div></div><div class="col-md-10 col-12" data-v-a49f4c2c data-v-a49f4c2c><div class="sns-link text-md-right" data-v-a49f4c2c><a href="https://github.com/serverless-operations" target="_blank" class="sns-link__github" data-v-a49f4c2c><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" data-v-a49f4c2c></i></a><a href="https://twitter.com/slsopsinc" target="_blank" class="sns-link__twitter" data-v-a49f4c2c><i aria-hidden="true" class="v-icon notranslate mdi mdi-twitter theme--light" data-v-a49f4c2c></i></a></div></div><div class="footer-copyright" data-v-a49f4c2c>
        © Serverless Operations, inc
      </div></div></div></footer></div></div>
    <script>window.__INITIAL_STATE__={"data":{"wordPressBlog":{"title":"AWS Lambdaのユニットテストのベストプラクティス(Node.js)","content":"\n\u003Ch2 class=\"wp-block-heading\"\u003E概要\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003Eみなさん、テスト書いてますかーー！\u003Cbr\u003EAWS Lambdaはサーバーレスアーキテクチャを構成する上で、重要なサービスです。そして、その特性上、ユニットテストを書いて変更に強いコードにすることが、継続的なメンテナンスや改善を行っていく上で非常に重要なものとなります。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Eこの記事は、まずローカルで行うLambdaのユニットテストについてその具体的な手法を書いています。なお、ベストプラクティスってタイトルにしてますが、これはベストプラクティスのひとつであり、その要件ややりたいことや個人的な趣味趣向によって変わってくるということは理解してるので、ひとつのやり方としてみなさんの参考になればと思っています。\u003C\u002Fp\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eテスト対象のLambdaとその要件\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003Eでは、まず初めにテスト対象となるLambdaファンクションの要件を以下のように定義してみます。これを元にしてテストを書きつつその流れを解説したいと思います。\u003C\u002Fp\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003E要件\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003Eまずは今回の要件です。DynamoDBに以下のBlogテーブルが存在していたとしましょう。\u003C\u002Fp\u003E\n\n\n\n\u003Cfigure class=\"wp-block-table\"\u003E\u003Ctable\u003E\u003Cthead\u003E\u003Ctr\u003E\u003Cth\u003Ekey\u003C\u002Fth\u003E\u003Cth\u003E用途\u003C\u002Fth\u003E\u003C\u002Ftr\u003E\u003C\u002Fthead\u003E\u003Ctbody\u003E\u003Ctr\u003E\u003Ctd\u003Epost_id\u003C\u002Ftd\u003E\u003Ctd\u003E記事ID(ハッシュキー)\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Epost_title\u003C\u002Ftd\u003E\u003Ctd\u003Eタイトル\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Epost_content\u003C\u002Ftd\u003E\u003Ctd\u003E本文\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003C\u002Ftbody\u003E\u003C\u002Ftable\u003E\u003C\u002Ffigure\u003E\n\n\n\n\u003Cp\u003E以下のような実装を行いたいと考えてみます。\u003Cbr\u003E&#8211; post_idがLambdaへの外部からの入力値となる\u003Cbr\u003E&#8211; post_idを元にBlogテーブルを検索して、該当のpost_titleとpost_contentを取得する\u003Cbr\u003E&#8211; post_titleとpost_contentを返す\u003C\u002Fp\u003E\n\n\n\n\u003Ch4 class=\"wp-block-heading\"\u003E処理の流れ\u003C\u002Fh4\u003E\n\n\n\n\u003Cp\u003Eこの処理の流れをフローチャートにすると以下のようになります。\u003Cbr\u003E\u003Ca href=\"https:\u002F\u002Fqiita-user-contents.imgix.net\u002Fhttps%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F65478%2F86b4d71d-1583-0e01-b2c9-0cd85406d9ca.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=17a2fb0da65b95868261df8e2a3c29cd\" target=\"_blank\" rel=\"noreferrer noopener\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003Eテストのパターン\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003Eまずは、どういったテストを網羅する必要があるのかを考えてみます。上記のフローチャートを見ながら、正常系と異常系に分けて考えてみましょう。\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E以下のようなパターンが考えられると思います。\u003C\u002Fp\u003E\n\n\n\n\u003Ch4 class=\"wp-block-heading\"\u003E正常系\u003C\u002Fh4\u003E\n\n\n\n\u003Cul\u003E\u003Cli\u003Epost_idが渡され、Blogテーブルから検索したデータを返した\u003C\u002Fli\u003E\u003C\u002Ful\u003E\n\n\n\n\u003Ch4 class=\"wp-block-heading\"\u003E異常系\u003C\u002Fh4\u003E\n\n\n\n\u003Cul\u003E\u003Cli\u003ELambdaにpost_idが渡されなかった\u003C\u002Fli\u003E\u003Cli\u003Epost_idはLambdaに渡されたが、Blogテーブルに該当のデータが無かった\u003C\u002Fli\u003E\u003Cli\u003EDynamoDB自体が落ちていて処理されなかった\u003C\u002Fli\u003E\u003C\u002Ful\u003E\n\n\n\n\u003Cp\u003Eでは、これからこの4パターンでテストコードを作っていきましょう。\u003C\u002Fp\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003E使用するユニットテスト用のライブラリ\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003Eまずはテストコードを書く前にユニットテストに使用したライブラリを紹介します。\u003Cbr\u003ENode.jsでテストを書く場合は良く出てくるライブラリですので覚えていて損は無いでしょう。\u003C\u002Fp\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003Echai\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003E\u003Ca href=\"http:\u002F\u002Fchaijs.com\u002F\" rel=\"noreferrer noopener\" target=\"_blank\"\u003Ehttp:\u002F\u002Fchaijs.com\u002F\u003C\u002Fa\u003E&nbsp;はJavaScript用のアサーションライブラリです。これを使うことで、期待通りの入力値と出力値になっているか比較して、テストの成否を判定します。\u003C\u002Fp\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003EChai as Promised\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fdomenic\u002Fchai-as-promised\" rel=\"noreferrer noopener\" target=\"_blank\"\u003Ehttps:\u002F\u002Fgithub.com\u002Fdomenic\u002Fchai-as-promised\u003C\u002Fa\u003E&nbsp;はchaiのPromise用の拡張です。\u003Cbr\u003EPromiseの状態がどうなっているかを判定します。\u003C\u002Fp\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003EMocha\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fmochajs.org\u002F\" rel=\"noreferrer noopener\" target=\"_blank\"\u003Ehttps:\u002F\u002Fmochajs.org\u002F\u003C\u002Fa\u003E&nbsp;はテスティングフレームワークライブラリです。テストを書くための枠組みを提供してくれたり、コマンドラインからの実行をサポートしてくれたり、\u003Ccode\u003EbeforeEach()\u003C\u002Fcode\u003Eや\u003Ccode\u003Eafter()\u003C\u002Fcode\u003Eといったテスト前後の定形処理を行う関数を提供してくれたりします。テストを実行するための環境を整えてくれるライブラリです。\u003C\u002Fp\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003Eproxyquire\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fthlorenz\u002Fproxyquire\" rel=\"noreferrer noopener\" target=\"_blank\"\u003Ehttps:\u002F\u002Fgithub.com\u002Fthlorenz\u002Fproxyquire\u003C\u002Fa\u003E&nbsp;はrequireモジュールをスタブ化して動作を変更します。要はローカルでテストするにあたって、aws-sdkが毎回AWSに接続されてしまってはテストが出来ません。そこでproxyquireを使うことでaws-sdkの処理を書き換え、ローカルでテストが行えるようにします。\u003C\u002Fp\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003Esinon\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003E\u003Ca href=\"http:\u002F\u002Fsinonjs.org\u002F\" rel=\"noreferrer noopener\" target=\"_blank\"\u003Ehttp:\u002F\u002Fsinonjs.org\u002F\u003C\u002Fa\u003E&nbsp;はテスト用にスタブやモック、スパイを作ってくれるライブラリです。今回はスパイの用途で使用して、proxyquireでスタブ化されたaws-sdkが仕様にそって呼び出されているかをチェックします。\u003C\u002Fp\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003EIstanbul\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fistanbul.js.org\u002F\" rel=\"noreferrer noopener\" target=\"_blank\"\u003Ehttps:\u002F\u002Fistanbul.js.org\u002F\u003C\u002Fa\u003E&nbsp;はコードのカバレッジ計測をしてくれるライブラリです。例えばif文がひとつ追加されると、単純にテストケースとしては2つのケースに分岐されます。そういった形でソースコードの静的解析を行うことでどの程度全体のテストが網羅されているのかを計測します\u003C\u002Fp\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eメインのソースコード\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003Eまずは先にLambdaファンクションのソースコードを載せておきます。上記のフローチャートをそのままLambdaに落とし込むと以下のようになります。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-js\"\u003E\u003Ccode\u003E'use strict'\nconst aws = require('aws-sdk')\nconst dynamodb = new aws.DynamoDB.DocumentClient()\n\nmodule.exports.blog = (event, context, callback) =\u003E {\n  return Promise.resolve().then(() =\u003E {\n    if (!event.post_id) {\n      return Promise.reject(responseBilder(400, {message: 'invalid param'}))\n    }\n\n    const params = {\n      TableName: 'Blog',\n      Key: {\n        post_id: event.post_id\n      }\n    }\n    return dynamodb.get(params).promise()\n  }).then(data =\u003E {\n    if (!Object.keys(data).length) {\n      return Promise.reject(responseBilder(404, {message: 'can not find specified post'}))\n    } else {\n      return Promise.resolve(responseBilder(200, {\n        post_title: data.Item.post_title,\n        post_content: data.Item.post_content\n      }))\n    }\n  })\n  .then(result =\u003E callback(null, result))\n  .catch(error =\u003E callback(error))\n}\n\nconst responseBilder = (statusCode, data) =\u003E {\n  return JSON.stringify({\n    statusCode: statusCode,\n    body: data\n  })\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cdiv class=\"gridsome-highlight\"\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-js\"\u003E\u003Ccode\u003Econst responseBilder = (statusCode, data) =\u003E {\n  return JSON.stringify({\n    statusCode: statusCode,\n    body: data\n  })\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eローカルで動作させるためのスタブの構築\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003ELambda内ではaws-sdkを使ってAWSリソースにアクセスすることが多くなるかと思います。ローカルでテストを行う場合に毎回AWSリソースにアクセスさせる必要はないため(aws-sdk自体の動作は、このアプリケーションのテストの範疇外)、スタブ化してダミーの値を返しつつ、どういう値で呼ばれたか、テスト内で監視を行うのが良いでしょう。\u003C\u002Fp\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003Esinonとproxyquireでaws-sdkをスタブ化する\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003Eスタブ化するにはproxyquireにてrequireで呼び出されるaws-sdkモジュールをスタブ化した上で、sinonのstubやspyと言ったメソッドで、スタブの呼び出しを監視しながらテストするのがベターです。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-js\"\u003E\u003Ccode\u003Econst sinon = require('sinon')\nconst proxyquire = require('proxyquire')\n\nconst proxyDynamoDB = class {\n  get (params) {\n    return {\n      promise: () =\u003E {}\n    }\n  }\n}\nconst lambda = proxyquire('.\u002Fhandler', {\n  'aws-sdk': {\n    DynamoDB: {\n      DocumentClient: proxyDynamoDB\n    }\n  }\n})\n\nconst dynamoDbGetStub = sinon.stub(proxyDynamoDB.prototype, 'get')\n.returns({promise: () =\u003E {\n  return Promise.resolve({\n    Item: {\n      post_title: 'aa',\n      post_content: 'bb'\n    }\n  })\n}})\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003Eだいたい予想はつくかと思いますが、上記の用に書くと、\u003Ccode\u003Edynamodb.get\u003C\u002Fcode\u003Eはスタブの返り値として指定したJSONを返却してくれます。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-json\"\u003E\u003Ccode\u003E{\n  \"Item\": {\n    \"post_title\": \"aa\",\n    \"post_content\": \"bb\"\n  }\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003E疑似Lambdaを実行させるための設定\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003Eテストを実行するために擬似的にローカルでLambdaを実行させる仕組みを用意します。\u003Cbr\u003E以下がLambdaファンクションのメイン部分なので、これを動かせるようにダミーの引数を与えれば良いということになります。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-js\"\u003E\u003Ccode\u003Emodule.exports.blog = (event, context, callback) =\u003E {\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003E以下の用に引数を定義しましょう。\u003Ccode\u003Econtext\u003C\u002Fcode\u003Eは今回使用してないので、\u003Ccode\u003E{}\u003C\u002Fcode\u003Eを指定しています。使用している場合は以下のドキュメントを参考にダミーの値を設定しましょう。\u003Cbr\u003E\u003Ca href=\"http:\u002F\u002Fdocs.aws.amazon.com\u002Fja_jp\u002Flambda\u002Flatest\u002Fdg\u002Fnodejs-prog-model-context.html\" rel=\"noreferrer noopener\" target=\"_blank\"\u003Ehttp:\u002F\u002Fdocs.aws.amazon.com\u002Fja_jp\u002Flambda\u002Flatest\u002Fdg\u002Fnodejs-prog-model-context.html\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003Eまた、\u003Ccode\u003Ecallback\u003C\u002Fcode\u003EにはPromiseを返すようにしていますが、これはテストの結果をPromiseで返えるようにして、値の検査をやりやすくしているためです。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-js\"\u003E\u003Ccode\u003Econst event = {\n  post_id: 'your-post-id'\n}\nconst callback = (error, result) =\u003E {\n  return new Promise((resolve, reject) =\u003E {\n    error ? reject(error) : resolve(result)\n  })\n}\nconst context = {}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eテストの実装\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003Eでは、それぞれのテストを実装していきましょう。\u003Cbr\u003Eテストのパターンは上記の4つです。それぞれのパターンに分けて解説していきます。\u003C\u002Fp\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003Epost_idが渡され、Blogテーブルから検索したデータを返した\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003EPromiseの状態が\u003Ccode\u003Efulfilled\u003C\u002Fcode\u003Eになっていること、DynamoDBのgetが1回実行されたこと、正常系の返り値が返ってきたことをテストしています。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-js\"\u003E\u003Ccode\u003Eit('Should return resolve when running successfully', () =\u003E {\n  return expect(lambda.blog(event, context, callback)).to.be.fulfilled.then(result =\u003E {\n    expect(dynamoDbGetStub.calledOnce).to.be.equal(true)\n    expect(result).to.deep.equal(JSON.stringify({\n      statusCode: 200,\n      body: {post_title: 'aa', post_content: 'bb'}\n    }))\n  })\n})\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003ELambdaにpost_idが渡されなかった\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003E先ほど、post_idをセットしていた\u003Ccode\u003Eevent\u003C\u002Fcode\u003Eを空オブジェクトで上書きします。\u003Cbr\u003EそしてPromiseの結果がrejectedになっていること、入力チェックで落ちたためにDynamoDBが呼ばれなかったこと、異常系の返り値が返ってきたことをテストしています。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-js\"\u003E\u003Ccode\u003Eit('Should return reject when post_id is not given', () =\u003E {\n  event = {}\n  return expect(lambda.blog(event, context, callback)).to.be.rejected.then(result =\u003E {\n    expect(dynamoDbGetStub.calledOnce).to.be.equal(false)\n    expect(result).to.deep.equal(JSON.stringify({\n      statusCode: 400,\n      body: {message: 'invalid param'}\n    }))\n  })\n})\n﻿\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003Epost_idはLambdaに渡されたが、Blogテーブルに該当のデータが無かった\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003EdynamoDbGetStubの返り値にデータが取得できなかった時の\u003Ccode\u003E{}\u003C\u002Fcode\u003Eが変えるようにスタブを設定します。そして、異常系の返り値が返ってきたことをテストしています。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-js\"\u003E\u003Ccode\u003Eit('Should return reject when you can not your item in DB', () =\u003E {\n  dynamoDbGetStub = sinon.stub(proxyDynamoDB.prototype, 'get')\n  .returns({promise: () =\u003E {\n    return Promise.resolve({})\n  }})\n  return expect(lambda.blog(event, context, callback)).to.be.rejected.then(result =\u003E {\n    expect(dynamoDbGetStub.calledOnce).to.be.equal(true)\n    expect(result).to.deep.equal(JSON.stringify({\n      statusCode: 404,\n      body: {message: 'can not find specified post'}\n    }))\n  })\n})\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Ch3 class=\"wp-block-heading\"\u003EDynamoDB自体が落ちていて処理されなかった\u003C\u002Fh3\u003E\n\n\n\n\u003Cp\u003EdynamoDbGetStubがrejectedされるようにスタブを設定します。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-js\"\u003E\u003Ccode\u003Eit('Should return reject when error occurs in DB', () =\u003E {\n  dynamoDbGetStub = sinon.stub(proxyDynamoDB.prototype, 'get')\n  .returns({promise: () =\u003E {\n    return Promise.reject('error')\n  }})\n  return expect(lambda.blog(event, context, callback)).to.be.rejected.then(result =\u003E {\n    expect(dynamoDbGetStub.calledOnce).to.be.equal(true)\n    expect(result).to.be.equal('error')\n  })\n})\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eテストの実行\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003Epackage.jsonにて以下のような設定を行いカバレッジの計測とテストの実行を\u003Ccode\u003Enpm run test\u003C\u002Fcode\u003Eで行えるようにします。\u003C\u002Fp\u003E\n\n\n\n\u003Cpre class=\"wp-block-code language-json\"\u003E\u003Ccode\u003E\"scripts\": {\n  \"test\": \"istanbul cover -x 'handler.test.js' node_modules\u002Fmocha\u002Fbin\u002F_mocha 'handler.test.js' -- -R spec --recursive\"\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\n\n\n\u003Cp\u003E実行結果は以下のとおりです。\u003Cbr\u003E4つともテストは成功して、カバレッジも100%問題なくテストできていることがわかります。\u003Cbr\u003E\u003Ca href=\"https:\u002F\u002Fqiita-user-contents.imgix.net\u002Fhttps%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F65478%2Fafc1fd38-5370-c43c-2cab-fc4abfb530f5.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a7e9738d7a7ca342ecd204272eba7031\" target=\"_blank\" rel=\"noreferrer noopener\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\n\n\u003Ch2 class=\"wp-block-heading\"\u003Eまとめ\u003C\u002Fh2\u003E\n\n\n\n\u003Cp\u003E今回解説したものは以下のGitHubにあげておりますので、興味のある方は確認してみてください\u003Cbr\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fhorike37\u002Flambda-unittest-sample\" rel=\"noreferrer noopener\" target=\"_blank\"\u003Ehttps:\u002F\u002Fgithub.com\u002Fhorike37\u002Flambda-unittest-sample\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\n\n\u003Cp\u003E如何でしたでしょうか。ぜひこれを参考にTest Driven Deveropment for Lambdaを実践していってもらえればと思います！\u003C\u002Fp\u003E\n","author":{"name":"Takahiro Horike","description":"Co-founder and CEO of Serverless Operations, Inc","avatars":{"avatar96":"https:\u002F\u002Fsecure.gravatar.com\u002Favatar\u002F2ee9db3a5b6c492acf66ec14c8a5d8dc?s=96&d=mm&r=g"},"acf":{"userJpName":"堀家 隆宏","userRole":"CEO","facebook":"https:\u002F\u002Fwww.facebook.com\u002Fhorike.takahiro","twitter":"https:\u002F\u002Ftwitter.com\u002Fhorike37","github":"https:\u002F\u002Fgithub.com\u002Fhorike37"}},"date":"2017.06.30","path":"\u002Fblog\u002F45\u002F","featuredMedia":{"sourceUrl":"https:\u002F\u002Fcdn.getshifter.co\u002Ff6642def64a63651c07142605e040674c5441f6d\u002Fuploads\u002F2017\u002F06\u002FAWS-Lambda_dark-bg@4x.png","altText":"","mediaDetails":{"width":300}},"categories":[{"id":"7","title":"Blog","path":"\u002Fcategory\u002Fblog\u002F"}],"tags":[{"id":"10","title":"Lambda","path":"\u002Ftag\u002Flambda\u002F"},{"id":"16","title":"ユニットテスト","path":"\u002Ftag\u002Fe3-83-a6-e3-83-8b-e3-83-83-e3-83-88-e3-83-86-e3-82-b9-e3-83-88\u002F"}]},"metadata":{"siteName":"Serverless Operations","siteDescription":"Serverless Operationsは、これまでグローバルの第一線で培ってきたクラウド技術（AWS − アマゾンウェブサービス）の豊富な実績と知見を活かし、お客さまのサーバーレスによる開発や運用の支援、コンサルティングまで一貫してサポート。サーバーレスに関するさまざまな課題を解決いたします。","siteUrl":"https:\u002F\u002Fserverless.co.jp","siteOgImage":"https:\u002F\u002Fserverless.co.jp\u002Fogp.png"}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.a1e03411.js" defer></script><script src="/assets/js/page--src--templates--word-press-blog-vue.fdf3ed1a.js" defer></script><script data-vue-tag="ssr" src="https://webfont.fontplus.jp/accessor/script/fontplus.js?LuMx0zy9taw%3D&box=ME4Rs88c3-0%3D&aa=1&ab=2" data-body="true"></script>
  </body>
</html>
