{"hash":"e5bf1eed04e22915fe60df772657de15feda3786","data":{"wordPressWorks":{"title":"ウェブ系サービスに必要なAPI課金システムをサーバーレスで構築、スタートアップ企業のスピード感とコストとニーズを満たすためAWSとStripeを活用","content":"\n<blockquote class=\"wp-block-quote\" id=\"block-fea071d1-567a-4b07-8145-95eaa300595e\"><p><strong>【サマリー】</strong><br><br>・API利用数に応じた料金が発生するウェブサービスの課金システムをAWSとStripeを利用してサーバーレスで開発<br>・Amazon Fargateを中心に請求にエラーが起きないことと、運用の省力化を重視してアーキテクチャを構成<br>・サービス開始まで料金体系が確定しないため、後から柔軟に課金モデルを変更できる仕様に</p></blockquote>\n\n\n\n<h2 class=\"wp-block-heading\">はじめに</h2>\n\n\n\n<p>株式会社Geoloniaは、提供している地図サービスの本格的な事業化に向け、課金システムの整備に着手。その設計と構築にあたって、Serverless Operationsにご依頼をいただきました。そのプロジェクトの詳細について、Geoloniaの代表取締役CEO 宮内 隆行さんと、Serverless Operations代表取締役の堀家さんにお話しをうかがいました。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"515\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/スクリーンショット-2021-04-19-13.00.38-1024x515.png\" alt=\"\" class=\"wp-image-369\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/スクリーンショット-2021-04-19-13.00.38-1024x515.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/スクリーンショット-2021-04-19-13.00.38-300x151.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/スクリーンショット-2021-04-19-13.00.38-768x387.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/スクリーンショット-2021-04-19-13.00.38-1536x773.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/スクリーンショット-2021-04-19-13.00.38-2048x1031.png 2048w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /><figcaption>左上から時計回りで、Serverless Operations堀家さん、Geolonia宮内さん、Geolonia鎌田さん、Geolonia小林さん、Serverless Operations金さん</figcaption></figure>\n\n\n\n<h2 class=\"wp-block-heading\">サーバーレスにしたいから選んだ開発会社</h2>\n\n\n\n<p>――地図サービスの課金システムの開発にあたって、GeoloniaからはServerless Operationsに対してどのようなアプローチがあったのでしょうか。</p>\n\n\n\n<p><strong>宮内</strong>　そもそも、弊社が地図のサービスを展開するうえで、サーバーをなくしたかったんです。これまでのようにサーバーを置いて、それがすべてのトラフィックをさばくやり方だと、地図データではインフラが大変なことになる。100GBを超えるような、すごく大きなデータなので。でも、サーバーレスでやろうとすると、わからないこと、不安なことがたくさんあります。そこで堀家さんに相談しました。</p>\n\n\n\n<p>いろんな開発会社があるなかで、Serverless Operationsだったのは、以前に堀家さんと一緒に仕事をしたことがあって、彼が「Serverless Framework」というオープンソースプロジェクトで活躍されていることを知っていたからです。だから、サーバーレス開発のことなら、堀家さんに聞くのが日本で一番確実だなと。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"855\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-01-1024x855.png\" alt=\"\" class=\"wp-image-363\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-01-1024x855.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-01-300x251.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-01-768x641.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-01.png 1231w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></figure>\n\n\n\n<p>――課金システムの以前に、そもそものサービス開発から一緒にされていたんですね。</p>\n\n\n\n<p><strong>宮内</strong>　はい。Serverless Operationsの協力もあって地図のサービスが形になってきたので、サービス開始に必要な課金システムを作ることにしました。自分たちで作ることも考えたのですが、社内のエンジニアが少ないのと、課金システムは不具合があるとお客様にも影響が大きいので、信頼できる外部の事業者に協力してもらうことにしました。</p>\n\n\n\n<p>それに、特定のエンジニアだけにまかせるとブラックボックスになりがちなので、係わるエンジニアを増やして多くの目に触れる状態にしたかったんです。そこで、もとの地図サービスを一緒に開発した、堀家さんに課金システムもお願いしました。</p>\n\n\n\n<p><strong>堀家</strong>　宮内さんからは最初「地図サービスの課金システムを作りたいんだけど、どうしたらいいかな」という、依頼というよりも相談みたいな形でお話しがありました。そこで、どのくらいの予算かうかがったうえで、開発における役割分担を切り分けを考えました。</p>\n\n\n\n<p>Serverless Operations側が主に設計やバックエンドの開発などを担当し、Geolonia側が主に実装や展開（CI/CD）、それにダッシュボード（利用者側のインターフェイス）の開発などを担当するという体制を提案して、それで進めることになりました。</p>\n\n\n\n<p>――具体的にはどういった体制で開発したのですか。</p>\n\n\n\n<p><strong>堀家</strong>　Geoloniaからは、鎌田さんというエンジニアが仕様決定や取りまとめ役として立ちました。Serverless Operationsからは、僕が設計とサービス選定、デモ開発を担当しました。僕から課金システムに利用するクラウドインフラや決済サービスを提案して、実際に動くデモを作って、鎌田さんがそれを見て決定する、という進め方でした。</p>\n\n\n\n<p>後半からは、Geoloniaから小林さんというエンジニアも参加して、お客さんにクレジットカード情報の登録してもらうダッシュボードの開発をしてもらい、Serverless Operationsからは私と、途中でもうひとりのエンジニアに交代してバックエンドを作りました。</p>\n\n\n\n<p>エンジニアは最大で4名がコミットして、期間は2020年の10月に開発を始め、2021年の2月いっぱいで終わりました。1月はほとんど作業をしなかったので、実質的には3カ月です。</p>\n\n\n\n<h2 class=\"wp-block-heading\">インフラにAmazon Fargateを選んだ理由</h2>\n\n\n\n<p>――課金システムは、どのような仕組みなんでしょうか。</p>\n\n\n\n<p><strong>堀家</strong>　Geoloniaの地図サービスは、利用者がAPIを呼び出して使うもので、サービスのアクセスログはAmazon S3（AWSのストレージサービス）に保存されています。そのアクセスログからAmazon Athena（S3上のデータをSQLで操作できるAWSのサービス）で必要なデータだけを取り出し、AWS Fargate（AWSのコンテナ向けサーバーレスコンピューティングエンジン）に設置したプログラムで集計処理をして、結果をAmazon DynamoDB（AWSのNoSQLデータベースサービス）に保存します。</p>\n\n\n\n<p>地図サービスのお客様への請求と決済には、Stripe（ネット向けの決済プラットフォームを提供する事業者）を使っています。あらかじめStripeに請求先やサイクル、料金体系、締め日などを設定しておくと、DynaboDBに保存した集計結果を元に月次の料金を計算して、請求日に請求書を自動的に発行してくれます。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"426\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-02-1024x426.png\" alt=\"\" class=\"wp-image-364\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-02-1024x426.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-02-300x125.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-02-768x320.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-02-1536x639.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-02.png 1600w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></figure>\n\n\n\n<p>――サーバーレスで開発するには多くのサービスがあり、AWSだけでも複数の選択肢があります。今回、Fargateを選択した理由はなんでしょうか。</p>\n\n\n\n<p><strong>堀家</strong>　コンピューティングエンジンに関しては、AWSに3つのサービスがあります。Lambda、Fargate、EC2と選択肢が3つあって、後にいくほど手間が増えていくんです。その替わり、できることの柔軟度が上がっていく。</p>\n\n\n\n<p>Lamdaは、考えることが少なくて済みますが、ひとつのプログラムが15分以上動かないんです。だから、15分以内で処理を終わらせるようにしないといけない。逆にEC2は、CPUをどれにするか、どのくらいの数を立ち上げるか、メモリをどうするか、とか初期設定で考えないといけないことがたくさん増える代わりに、Lamdaのような制限がなくて何でもできるんです。Fargateは、その中間でEC2ほどではないけれど初期設定が必要だけど、Lamdaほどの制限はない。</p>\n\n\n\n<p>僕は、サーバーレスで開発する場合、基本的にまずLamdaを検討するんです。今回の場合はログの集計処理で、ログはユーザー数や利用状況によってデータ量が大きく変動するので、データ量が大きい場合は15分を超えてしまう可能性がある。並列処理にするとか工夫することで対応できますが、データ量で処理時間が変化するので15分を過ぎるリスクが常にあります。それを考慮して、今回はFargateにしました。</p>\n\n\n\n<p>Fargateも内部は結局EC2ですが、あらかじめサービスの側である程度設定を上手くやってくれます。コンテナをFargateにポンと投げれば、それだけで動いてしまう。だから、普通にウェブでサービスを作る場合はFargateが一番多く選ばれていて、最初からEC2でやるというケースは少ない気がします。</p>\n\n\n\n<h2 class=\"wp-block-heading\">Stripeは開発者が使いやすい決済インフラ</h2>\n\n\n\n<p>――決済サービスについては、なぜStripeを選んだのですか。</p>\n\n\n\n<p><strong>堀家</strong>　決済サービスについては現状、Stripe一択という状況なので、特に迷うことはありませんでした。以前は、他にもサービスがあったのですが、そこも終了してしまったので、本当に選択肢がないんです。ただ、開発者にとってStripeはとても使いやすいんです。</p>\n\n\n\n<p>課金を処理するためのAPIが非常に使いやすかったり、サブスクリプションから従量制までいろんな課金の仕組みに対応できたり、開発に必要なドキュメントの整備であったり、サポートが体制が充実していたりするんです。</p>\n\n\n\n<p>――具体的にどういった点が、開発者にとって使いやすいのでしょうか。</p>\n\n\n\n<p><strong>堀家</strong>　サブスクリプションサービスで課金をする上で必要な機能が揃っているだけでなく、途中でプランを切り替えた場合の差額の処理といった、自分たちでゼロから考えて実装するにはかなり大変なところも、あらかじめ用意されているところですね。</p>\n\n\n\n<p>そうした場合、締め日に合わせて日割りでやるのか、それとも申し込み日に合わせて締め日を変えるのか、とか考えることがものすごく多いんです。それをStripeなら、サービスの側で上手くやってくれる。</p>\n\n\n\n<p>だから、Stripeしか選択肢がないというのは、ネガティブな意味ではなくてポジティブな本音です。Stripeに依存してベンダーロックインされているところもないです。ユーザーコミュニティも熱心に活動していて、ミートアップなども定期的に開催しているようです。こういうコミュニティがあるプロダクトは、個人的に信頼できると思っています。</p>\n\n\n\n<p><strong>宮内</strong>　地図サービスは、APIを介して利用するサービスなので、最初から漠然と「これとこれを数えておけば課金ができる」というイメージのはあったんです。そこを数える部分、ログの集計の部分をお願いしたんですけど、そこがすごいうまく動いているので、結果的にはどんな課金モデルでも対応できることになったので、良かったですね。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"535\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-0-1024x535.png\" alt=\"\" class=\"wp-image-365\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-0-1024x535.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-0-300x157.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-0-768x401.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-0-1536x803.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/pasted-image-0.png 1600w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></figure>\n\n\n\n<p>――課金システムの開発にあたって、重視したポイントはなんでしたか。</p>\n\n\n\n<p><strong>堀家</strong>　開発する上では、集計などでエラーが起きたときにどうするか気を付けました。エラー対応にはリカバリーのセオリーがあるので、それに沿った開発を行っています。ログ集計系については、先ほど述べたようにログの大きさでエラーが起きないように、コンピューティングエンジンを選んでいますし、決済系についてはStripeの信頼性が非常に高いので、そこに投げるデータさえ間違ってなければ問題ないです。クラウドサービスでの課金は、よく利用者側のミスで莫大な金額が請求されてしまうことがありますよね。そういったことがないようにしています。</p>\n\n\n\n<p><strong>宮内</strong>　課金で怖いのは、仕組みが間違っていてお客さんに多く請求してしまったり、少なく請求してしまったりすることです。少ない場合は、しょうがないですが（笑）。ただ、多く請求することは信用を失いますし、返金することになるとその手間も掛かる。</p>\n\n\n\n<p>それに、開発を相談した時点では、地図サービスの料金体系がまだ確定していなくて、流動的だったんですよね。地図サービスには、グーグルマップという大きな競合がいるので、その料金体系は常に意識しないといけないんです。だから、正式な料金体系は、つい先日にやっと決まったばかりです。</p>\n\n\n\n<p>課金システムを開発するのに料金モデルが決まらないので、サービスを開始するまで何ヶ月も開発に付き合ってもらうことになると思っていました。それが、思っていたよりもすんなりといけたのは良かったです。課金モデルも、Geolonia側からダッシュボード上の設定変更で対応できるので楽で助かります。</p>\n\n\n\n<p>――どうもありがとうございました。</p>\n","date":"2021.04.16","path":"/works/358/","featuredMedia":{"sourceUrl":"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/スクリーンショット-2021-04-19-20.32.35.png","altText":"株式会社Geolonia","mediaDetails":{"width":2132}},"categories":[{"id":"5","title":"Works","path":"/category/works/"}],"tags":[{"id":"45","title":"AWS Fargate","path":"/tag/aws-fargate/"},{"id":"44","title":"Geolonia","path":"/tag/geolonia/"},{"id":"20","title":"Stripe","path":"/tag/stripe/"}],"acf":{"companyName":"株式会社Geolonia","companyProfile":"<p><span style=\"font-weight: 400;\">株式会社Geoloniaは、地図や位置情報の新たな活用を目指すスタートアップ企業です。2019年9月に創業したばかりで、現在までに自由度の高いウェブ向けの地図サービスの提供や、一般社団法人不動産テック協会と共同での不動産共通ID事業などに取り組んでいます。</span></p>\n","companyLogo":{"sourceUrl":"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2021/04/logo.png","altText":""}}},"metadata":{"siteName":"Serverless Operations","siteDescription":"Serverless Operationsは、これまでグローバルの第一線で培ってきたクラウド技術（AWS − アマゾンウェブサービス）の豊富な実績と知見を活かし、お客さまのサーバーレスによる開発や運用の支援、コンサルティングまで一貫してサポート。サーバーレスに関するさまざまな課題を解決いたします。","siteUrl":"https://serverless.co.jp","siteOgImage":"https://serverless.co.jp/ogp.png"}},"context":{}}