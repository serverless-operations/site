{"hash":"51bbfd82cb20fb429b7eb8047edc7c53796980aa","data":{"wordPressBlog":{"title":"AppSync+Auth0で認証させたユーザのDynamoDB上のデータをCRUD操作させる","content":"\n<h2 class=\"wp-block-heading\">概要</h2>\n\n\n\n<p>AppSyncでAuth0を認証プロバイダーに使用した時にユーザの関連データをDynamoDBにも保存してCRUD操作をさせたいユースケースは結構あると思います。それをどのようにやればよいのかをこの記事では書いています。</p>\n\n\n\n<p>DynamoDBにUserMetaテーブルを追加して、AppSyncでAuth0によるOIDC認証をさせてGraphQLのMutationでデータを追加するみたいなケースを考えてみましょう。</p>\n\n\n\n<h2 class=\"wp-block-heading\">AppSync設定</h2>\n\n\n\n<h3 class=\"wp-block-heading\">認証</h3>\n\n\n\n<p>認証モードにOpenID Connectを選択してプロバイダードメインにAuth0のエンドポイントを追加しましょう。契約しているAuth0テナントごとに<code>https://&lt;テナント名&gt;.auth0.com</code> というURLが存在しているのでそれを設定します</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"447\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.13.58-1024x447.png\" alt=\"\" class=\"wp-image-82\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.13.58-1024x447.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.13.58-300x131.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.13.58-768x335.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.13.58-1536x670.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.13.58-2048x893.png 2048w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></figure>\n\n\n\n<h3 class=\"wp-block-heading\">GraphQLスキーマ設計</h3>\n\n\n\n<p>以下のようにUerMetaにユーザー名を登録するためのMutationを定義します</p>\n\n\n\n<pre class=\"wp-block-code language-graphql\"><code>type Mutation {\n\tpostUserMeta(name: String!): UserMeta\n}\n\ntype Query {\n\tgetUserMeta: UserMeta\n}\n\ntype UserMeta {\n\tid: String!\n\tname: String!\n}\n\nschema {\n\tquery: Query\n\tmutation: Mutation\n}</code></pre>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"785\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.26.29-1024x785.png\" alt=\"\" class=\"wp-image-83\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.26.29-1024x785.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.26.29-300x230.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.26.29-768x589.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.26.29-1536x1178.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.26.29.png 1818w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></figure>\n\n\n\n<h3 class=\"wp-block-heading\">DynamoDBテーブルの作成</h3>\n\n\n\n<p>次にDynamoDBのUserMetaテーブルを作成しましょう。idをプライマリキーとしてここにAuth0のUserIDが登録される想定です。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"826\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.23.27-1024x826.png\" alt=\"\" class=\"wp-image-84\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.23.27-1024x826.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.23.27-300x242.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.23.27-768x619.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.23.27.png 1446w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></figure>\n\n\n\n<h3 class=\"wp-block-heading\">データソースの作成</h3>\n\n\n\n<p>AppSyncのコンソールに戻って次はスキーマとマッピングするためのデータソースを作成します。データソースにはDynamoDBテーブルを指定して、先程作成したテーブルを指定しましょう。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"780\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.28.14-1024x780.png\" alt=\"\" class=\"wp-image-85\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.28.14-1024x780.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.28.14-300x228.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.28.14-768x585.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.28.14-1536x1169.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.28.14-2048x1559.png 2048w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></figure>\n\n\n\n<h3 class=\"wp-block-heading\">リゾルバの作成</h3>\n\n\n\n<p>スキーマ設計の画面に戻り以下の赤枠をクリックしてリゾルバを作成してデータソースとの紐付けを行います。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"503\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.34.29-1024x503.png\" alt=\"\" class=\"wp-image-86\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.34.29-1024x503.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.34.29-300x147.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.34.29-768x377.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.34.29-1536x755.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.34.29-2048x1006.png 2048w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></figure>\n\n\n\n<p><strong><code>$ctx.identity.sub</code></strong> でOIDCで認証したユーザのUserIDがリゾルバ上で取得できます。これをキーにDynamoDB上のデータを操作します。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"750\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.51.37-1024x750.png\" alt=\"\" class=\"wp-image-91\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.51.37-1024x750.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.51.37-300x220.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.51.37-768x563.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.51.37-1536x1125.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.51.37-2048x1500.png 2048w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></figure>\n\n\n\n<p></p>\n\n\n\n<h2 class=\"wp-block-heading\">動作確認</h2>\n\n\n\n<p>Auth0でサンプルのSPAアプリを作り、ユーザログインしてそのIDトークンをコピーします。Auth0のSDKを使えば以下のようなコードで取得できますね。</p>\n\n\n\n<pre class=\"wp-block-code language-js\"><code>const claims = await auth0.getIdTokenClaims();\nconsole.log(claims.__raw)</code></pre>\n\n\n\n<p>このユーザのIDは<code>auth0|5ef312c92f184a001366fd8b</code> となるのでこれがDynamoDBに登録されていればOKです</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"439\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.44.47-1024x439.png\" alt=\"\" class=\"wp-image-88\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.44.47-1024x439.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.44.47-300x129.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.44.47-768x329.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.44.47-1536x658.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.44.47-2048x878.png 2048w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></figure>\n\n\n\n<p>AppSyncのクエリ機能を使ってテストします。OpenIDコネクトからコピペしたIDトークンを入力してクエリを実行すると以下のように成功しました。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"471\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.51.50-1024x471.png\" alt=\"\" class=\"wp-image-89\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.51.50-1024x471.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.51.50-300x138.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.51.50-768x353.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.51.50-1536x706.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.51.50-2048x941.png 2048w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></figure>\n\n\n\n<p>ちゃんとDynamoDBにもデータが出来ています。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"950\" height=\"856\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.55.25.png\" alt=\"\" class=\"wp-image-92\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.55.25.png 950w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.55.25-300x270.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-11-18.55.25-768x692.png 768w\" sizes=\"(max-width: 950px) 100vw, 950px\" /></figure>\n\n\n\n<p></p>\n","author":{"name":"Takahiro Horike","description":"Co-founder and CEO of Serverless Operations, Inc","avatars":{"avatar96":"https://secure.gravatar.com/avatar/2ee9db3a5b6c492acf66ec14c8a5d8dc?s=96&d=mm&r=g"},"acf":{"userJpName":"堀家 隆宏","userRole":"CEO","facebook":"https://www.facebook.com/horike.takahiro","twitter":"https://twitter.com/horike37","github":"https://github.com/horike37"}},"date":"2020.07.11","path":"/blog/81/","featuredMedia":{"sourceUrl":"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/07/スクリーンショット-2020-07-12-17.14.50.png","altText":"","mediaDetails":{"width":1442}},"categories":[{"id":"7","title":"Blog","path":"/category/blog/"}],"tags":[{"id":"19","title":"Appsync","path":"/tag/appsync/"},{"id":"15","title":"Auth0","path":"/tag/auth0/"}]},"metadata":{"siteName":"Serverless Operations","siteDescription":"Serverless Operationsは、これまでグローバルの第一線で培ってきたクラウド技術（AWS − アマゾンウェブサービス）の豊富な実績と知見を活かし、お客さまのサーバーレスによる開発や運用の支援、コンサルティングまで一貫してサポート。サーバーレスに関するさまざまな課題を解決いたします。","siteUrl":"https://serverless.co.jp","siteOgImage":"https://serverless.co.jp/ogp.png"}},"context":{}}