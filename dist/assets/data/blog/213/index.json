{"hash":"35053359aff549c8e1d81009f00eae950570ae45","data":{"wordPressBlog":{"title":"サーバーレスアーキテクチャを採用する際のコストに対する重要な考え方","content":"\n<p>サーバーレスアーキテクチャを採用する理由として、コスト削減が挙げられるケースをしばしば耳にします。しかし本当にコストは常に削減されるのでしょうか？</p>\n\n\n\n<p>EC2に対するAWS Lambdaのコストのメリットを説明するために、以下のような図が用いられるケースがあります。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"618\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.33.58-1024x618.png\" alt=\"\" class=\"wp-image-214\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.33.58-1024x618.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.33.58-300x181.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.33.58-768x463.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.33.58.png 1452w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></figure>\n\n\n\n<p>サーバーが起動していた時間に対して課金されるEC2に対して、AWS Lambdaはプログラムが実行された時間に対して課金されるため、最終的にはコストが最適化されることをこの図では説明しています。では、実際にどんな場合にでもコストは最適化・削減されているのかを見ていきましょう。</p>\n\n\n\n<h2 class=\"wp-block-heading\">LambdaとEC2のコストを比較する</h2>\n\n\n\n<h3 class=\"wp-block-heading\">トラフィックが少ないワークロードの場合</h3>\n\n\n\n<p>月間2万リクエスト、1リクエスト辺りのプログラムの平均実行時間が0.5秒、必要なメモリサイズは512MBのワークロードを考えてみましょう。t3.microインスタンスでこのトラフィックをさばけたと仮定して、以下のようになります。</p>\n\n\n\n<figure class=\"wp-block-image size-large is-resized\"><img decoding=\"async\" loading=\"lazy\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.45.44-1024x315.png\" alt=\"\" class=\"wp-image-215\" width=\"835\" height=\"256\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.45.44-1024x315.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.45.44-300x92.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.45.44-1536x473.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.45.44-2048x631.png 2048w\" sizes=\"(max-width: 835px) 100vw, 835px\" /></figure>\n\n\n\n<p>結果、AWS Lambdaが圧倒的に安くなることが分かります。次に大きなトラフィックを捌く場合を見てみましょう</p>\n\n\n\n<h3 class=\"wp-block-heading\">トラフィックが大きなワークロードの場合</h3>\n\n\n\n<p>月間3千万リクエスト、1リクエスト辺りのプログラムの平均実行時間が0.5秒、必要なメモリサイズは2048MBのワークロードを考えてみましょう。m5.largeインスタンスでこのトラフィックをさばけたと仮定して、以下のようになります。</p>\n\n\n\n<figure class=\"wp-block-image size-large is-resized\"><img decoding=\"async\" loading=\"lazy\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.51.46-1024x302.png\" alt=\"\" class=\"wp-image-216\" width=\"824\" height=\"243\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.51.46-1024x302.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.51.46-300x89.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.51.46-768x227.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.51.46-1536x453.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.51.46-2048x605.png 2048w\" sizes=\"(max-width: 824px) 100vw, 824px\" /></figure>\n\n\n\n<p>結果、AWS Lambdaがコストは高くなることが分かります。</p>\n\n\n\n<p>サーバーレスのサービスは「動いた分だけ」という課金体系になっていることが多く、たくさんのトラフィックを捌くためにはそれなりにコストがかかることが分かります。<br>他の例を見てみましょう。</p>\n\n\n\n<h2 class=\"wp-block-heading\">API GatewayとApplication Load Balancerのコストを比較してみる</h2>\n\n\n\n<p>トラフィックが少ないワークロードと大きなワークロードでそれぞれ比較します。同じ様にトラフィックが少ないうちはAPI Gatewayが安いですが、トラフィックが大きくなると高くなる傾向にあることが分かります。</p>\n\n\n\n<figure class=\"wp-block-image size-large is-resized\"><img decoding=\"async\" loading=\"lazy\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.57.39-1024x364.png\" alt=\"\" class=\"wp-image-217\" width=\"819\" height=\"291\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.57.39-1024x364.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.57.39-300x107.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.57.39-768x273.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.57.39-1536x547.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.57.39-2048x729.png 2048w\" sizes=\"(max-width: 819px) 100vw, 819px\" /><figcaption>トラフィックが少ないワークロード</figcaption></figure>\n\n\n\n<figure class=\"wp-block-image size-large is-resized\"><img decoding=\"async\" loading=\"lazy\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.57.54-1024x356.png\" alt=\"\" class=\"wp-image-218\" width=\"813\" height=\"282\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.57.54-1024x356.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.57.54-300x104.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.57.54-768x267.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.57.54-1536x534.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-21.57.54-2048x712.png 2048w\" sizes=\"(max-width: 813px) 100vw, 813px\" /><figcaption>トラフィックが大きなワークロード</figcaption></figure>\n\n\n\n<h3 class=\"wp-block-heading\">大きなワークロードではALBを選んだほうがいいのか？</h3>\n\n\n\n<p>そうとは限りません。API Gatewayに合って、ALBには無い機能がいくつかあります。以下のような機能です。これらを使いたい場合はAPI Gatewayを選択するべきでしょう。</p>\n\n\n\n<ul><li>認証認可のためにいくつかの機能(Lambda AuthorizerやIAM Authorizerなど)</li><li>リクエストバリデーション</li><li>Cache</li><li>Usage plan</li><li>サービスプロキシインテグレーション</li></ul>\n\n\n\n<p>また、Serverless FrameworkなどのIaCのツールを使ってデプロイする際にもAPI Gatewayの方が全体の記述量が少なく、手軽なケースが多いでしょう。ALBは先にリスナーなどを定義する必要があるため少し複雑です。</p>\n\n\n\n<h2 class=\"wp-block-heading\">DynamoDBとElasticache Redisのコストを比較してみる</h2>\n\n\n\n<p>同様にトラフィックが少ないワークロードと大きなワークロードでそれぞれ比較します。やはり、トラフィックやストレージ使用量が少ないうちはサーバーレスなDBであるDynamoDBが安いですが、大きなワークロードになるとそれが逆転することが分かります。</p>\n\n\n\n<figure class=\"wp-block-image size-large is-resized\"><img decoding=\"async\" loading=\"lazy\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-22.08.00-1024x304.png\" alt=\"\" class=\"wp-image-219\" width=\"780\" height=\"231\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-22.08.00-1024x304.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-22.08.00-300x89.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-22.08.00-768x228.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-22.08.00-1536x456.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-22.08.00-2048x609.png 2048w\" sizes=\"(max-width: 780px) 100vw, 780px\" /><figcaption>トラフィックが少ないワークロード</figcaption></figure>\n\n\n\n<figure class=\"wp-block-image size-large is-resized\"><img decoding=\"async\" loading=\"lazy\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-22.08.10-1024x309.png\" alt=\"\" class=\"wp-image-220\" width=\"781\" height=\"236\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-22.08.10-1024x309.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-22.08.10-300x90.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-22.08.10-768x232.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-22.08.10-1536x463.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-22.08.10-2048x618.png 2048w\" sizes=\"(max-width: 781px) 100vw, 781px\" /><figcaption>トラフィックが大きなワークロード</figcaption></figure>\n\n\n\n<h3 class=\"wp-block-heading\">運用コストの違い</h3>\n\n\n\n<p>Elasticache Redisを使った方が一般的には運用面のコストは高くなるでしょう。インスタンスの管理やノードの管理はユーザで実施する必要があります。また、ノードの増減などのオペレーションに備えて手順を準備しておく必要もあります。</p>\n\n\n\n<p>また、ElasticacheにVPCが必要なことも大きな違いでしょう。冗長化などの信頼性確保はユーザで実施する必要があります。</p>\n\n\n\n<p>DynamoDBであれば、インスタンスサイズを選定する必要もなければ、ノードの管理も不要です。冗長化もAWS側で実施してくれるため、運用面でのコストはDynamoDBに大きなメリットがあります。</p>\n\n\n\n<h2 class=\"wp-block-heading\">まとめ</h2>\n\n\n\n<p>サーバーレスのコストを考える時はAWS自体のコストだけでなく、TCO(Total Cost of Ownership)で考えることが重要です。</p>\n\n\n\n<figure class=\"wp-block-image size-large\"><img decoding=\"async\" loading=\"lazy\" width=\"1024\" height=\"347\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-23.00.58-1024x347.png\" alt=\"\" class=\"wp-image-226\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-23.00.58-1024x347.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-23.00.58-300x102.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-23.00.58-768x261.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-23.00.58-1536x521.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-23.00.58-2048x695.png 2048w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></figure>\n\n\n\n<p>極端な例かもしれませんが、例えばDynamoDBでなくElasticache Redisを採用して、運用専門のソフトウェアエンジニアを１人雇用したとすれば、100万円 &#8211; 200万程度のコストはかかってくるでしょう。これとAWS自体にかかるコストを足した時にどちらにメリットがあるのか、将来のコストも含めて検討する必要があるでしょう。</p>\n\n\n\n<figure class=\"wp-block-image size-large is-resized\"><img decoding=\"async\" loading=\"lazy\" src=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-23.19.40-1024x575.png\" alt=\"\" class=\"wp-image-227\" width=\"580\" height=\"325\" srcset=\"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-23.19.40-1024x575.png 1024w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-23.19.40-300x169.png 300w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-23.19.40-768x432.png 768w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-23.19.40-1536x863.png 1536w, https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/スクリーンショット-2020-10-12-23.19.40.png 1794w\" sizes=\"(max-width: 580px) 100vw, 580px\" /></figure>\n\n\n\n<p>サーバーレスのサービスのメリットは、インフラストラクチャにおける様々な運用をクラウドベンダーが肩代わりしてくれることです。それにより目には見えにくい運用コストを削減させて、ビジネスロジックな重要な部分にエンジニアリングリソースを集中させることが出来ます。</p>\n\n\n\n<p>サーバーレスアーキテクチャを採用する場合はこういった観点でコストを捉えることで、メリットとなる要点は何になるのか。分かりやすくなるかもしれません。</p>\n","author":{"name":"Takahiro Horike","description":"Co-founder and CEO of Serverless Operations, Inc","avatars":{"avatar96":"https://secure.gravatar.com/avatar/2ee9db3a5b6c492acf66ec14c8a5d8dc?s=96&d=mm&r=g"},"acf":{"userJpName":"堀家 隆宏","userRole":"CEO","facebook":"https://www.facebook.com/horike.takahiro","twitter":"https://twitter.com/horike37","github":"https://github.com/horike37"}},"date":"2020.10.12","path":"/blog/213/","featuredMedia":{"sourceUrl":"https://cdn.getshifter.co/f6642def64a63651c07142605e040674c5441f6d/uploads/2020/10/igal-ness-9wY2ofzQ9Us-unsplash-scaled.jpg","altText":"","mediaDetails":{"width":2560}},"categories":[{"id":"7","title":"Blog","path":"/category/blog/"}],"tags":[{"id":"30","title":"cost","path":"/tag/cost/"}]},"metadata":{"siteName":"Serverless Operations","siteDescription":"Serverless Operationsは、これまでグローバルの第一線で培ってきたクラウド技術（AWS − アマゾンウェブサービス）の豊富な実績と知見を活かし、お客さまのサーバーレスによる開発や運用の支援、コンサルティングまで一貫してサポート。サーバーレスに関するさまざまな課題を解決いたします。","siteUrl":"https://serverless.co.jp","siteOgImage":"https://serverless.co.jp/ogp.png"}},"context":{}}